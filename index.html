<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Inventory Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .page-content { display: none; }
    .nav-link.active { background-color: #4f46e5; color: white; font-weight: 600; }
    .dark .nav-link.active { background-color: #6366f1; }
    .nav-link:not(.active):hover, .nav-link-sub:hover { background-color: #f3f4f6; color: #1f2937; }
    .dark .nav-link:not(.active):hover, .dark .nav-link-sub:hover { background-color: #374151; color: #f9fafb; }
    .nav-link-sub.active { color: #4f46e5; font-weight: 600; }
    .dark .nav-link-sub.active { color: #a5b4fc; }
    .modal { transition: opacity 0.3s ease; }
    .modal-content { transition: all 0.3s ease; }
    .modal.opacity-0 .modal-content { transform: scale(0.95); }
    #sidebar { transition: transform 0.3s ease-in-out; }
    details > summary { list-style: none; }
    details > summary::-webkit-details-marker { display: none; }
    /* Ensure table layout is fixed to respect column widths */
    .table-fixed { table-layout: fixed; width: 100%; }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">
  <div class="relative min-h-screen md:flex">
    <!-- Mobile Menu Button -->
    <div class="md:hidden flex justify-between items-center bg-white dark:bg-gray-800 p-4 border-b dark:border-gray-700">
        <div class="flex items-center space-x-3">
            <i class="fas fa-cubes text-2xl text-indigo-600"></i>
            <h1 class="text-xl font-bold text-gray-800 dark:text-white">Inventory</h1>
        </div>
        <button id="mobile-menu-button" class="text-gray-500 dark:text-gray-400 focus:outline-none">
            <i class="fas fa-bars text-2xl"></i>
        </button>
    </div>

    <!-- Sidebar Navigation -->
    <nav id="sidebar" class="w-64 bg-white dark:bg-gray-800 border-r dark:border-gray-700 p-5 flex flex-col flex-shrink-0 fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 z-30">
        <div class="flex items-center justify-between mb-10">
            <div class="flex items-center space-x-3">
                <i class="fas fa-cubes text-2xl text-indigo-600"></i>
                <h1 class="text-xl font-bold text-gray-800 dark:text-white">Inventory</h1>
            </div>
             <button id="theme-toggle-desktop" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none hidden md:block">
                <i class="fas fa-moon text-gray-500 dark:text-gray-400"></i>
                <i class="fas fa-sun text-gray-500 dark:text-gray-400 hidden"></i>
            </button>
        </div>
        <ul class="space-y-2">
            <li><a href="#" id="nav-dashboard" onclick="loadPage('Dashboard', this); return false;" class="nav-link flex items-center space-x-3 px-4 py-2.5 rounded-lg text-gray-600 dark:text-gray-300"><i class="fas fa-tachometer-alt w-5 text-center"></i><span>Dashboard</span></a></li>
            <li>
                <details class="group">
                    <summary class="nav-link flex items-center justify-between px-4 py-2.5 rounded-lg text-gray-600 dark:text-gray-300 cursor-pointer">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-laptop w-5 text-center"></i>
                            <span>Computers</span>
                        </div>
                        <i class="fas fa-chevron-right text-xs transform group-open:rotate-90 transition-transform"></i>
                    </summary>
                    <ul class="pl-8 pt-2 space-y-1">
                        <li><a href="#" onclick="loadPage('Computers', this, 'Desktop'); return false;" class="nav-link-sub block px-4 py-2 text-sm rounded-md text-gray-500 dark:text-gray-400">Desktop</a></li>
                        <li><a href="#" onclick="loadPage('Computers', this, 'Laptop'); return false;" class="nav-link-sub block px-4 py-2 text-sm rounded-md text-gray-500 dark:text-gray-400">Laptop</a></li>
                        <li><a href="#" onclick="loadPage('Computers', this, 'MacBook'); return false;" class="nav-link-sub block px-4 py-2 text-sm rounded-md text-gray-500 dark:text-gray-400">MacBook</a></li>
                        <li><a href="#" onclick="loadPage('Computers', this, 'POS'); return false;" class="nav-link-sub block px-4 py-2 text-sm rounded-md text-gray-500 dark:text-gray-400">POS</a></li>
                        <li><a href="#" onclick="loadPage('Computers', this, null); return false;" class="nav-link-sub block px-4 py-2 text-sm rounded-md text-gray-500 dark:text-gray-400">All</a></li>
                    </ul>
                </details>
            </li>
            <li><a href="#" id="nav-monitors" onclick="loadPage('Monitors', this); return false;" class="nav-link flex items-center space-x-3 px-4 py-2.5 rounded-lg text-gray-600 dark:text-gray-300"><i class="fas fa-desktop w-5 text-center"></i><span>Monitors</span></a></li>
            <li><a href="#" id="nav-audio" onclick="loadPage('Audio', this); return false;" class="nav-link flex items-center space-x-3 px-4 py-2.5 rounded-lg text-gray-600 dark:text-gray-300"><i class="fas fa-volume-up w-5 text-center"></i><span>Audio</span></a></li>
            <li>
                <details class="group">
                    <summary class="nav-link flex items-center justify-between px-4 py-2.5 rounded-lg text-gray-600 dark:text-gray-300 cursor-pointer">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-keyboard w-5 text-center"></i>
                            <span>Accessory</span>
                        </div>
                        <i class="fas fa-chevron-right text-xs transform group-open:rotate-90 transition-transform"></i>
                    </summary>
                    <ul class="pl-8 pt-2 space-y-1">
                        <li><a href="#" onclick="loadPage('Accessory', this, 'Mouse'); return false;" class="nav-link-sub block px-4 py-2 text-sm rounded-md text-gray-500 dark:text-gray-400">Mouse</a></li>
                        <li><a href="#" onclick="loadPage('Accessory', this, 'Keyboard'); return false;" class="nav-link-sub block px-4 py-2 text-sm rounded-md text-gray-500 dark:text-gray-400">Keyboard</a></li>
                        <li><a href="#" onclick="loadPage('Accessory', this, 'Webcam'); return false;" class="nav-link-sub block px-4 py-2 text-sm rounded-md text-gray-500 dark:text-gray-400">Webcam</a></li>
                        <li><a href="#" onclick="loadPage('Accessory', this, 'UPS'); return false;" class="nav-link-sub block px-4 py-2 text-sm rounded-md text-gray-500 dark:text-gray-400">UPS</a></li>
                        <li><a href="#" onclick="loadPage('Accessory', this, null); return false;" class="nav-link-sub block px-4 py-2 text-sm rounded-md text-gray-500 dark:text-gray-400">All</a></li>
                    </ul>
                </details>
            </li>
            <li><a href="#" id="nav-software" onclick="loadPage('Software', this); return false;" class="nav-link flex items-center space-x-3 px-4 py-2.5 rounded-lg text-gray-600 dark:text-gray-300"><i class="fas fa-cogs w-5 text-center"></i><span>Software</span></a></li>
            <li class="pt-4"><div class="px-4 text-xs font-semibold uppercase text-gray-400">Management</div></li>
            <li><a href="loan.html" target="_blank" class="nav-link flex items-center space-x-3 px-4 py-2.5 rounded-lg text-gray-600 dark:text-gray-300"><i class="fas fa-external-link-alt w-5 text-center"></i><span>หน้ายืม-คืน (User)</span></a></li>
            <li><a href="#" id="nav-loanhistory" onclick="loadPage('LoanHistory', this); return false;" class="nav-link flex items-center space-x-3 px-4 py-2.5 rounded-lg text-gray-600 dark:text-gray-300"><i class="fas fa-history w-5 text-center"></i><span>ประวัติการยืม</span></a></li>
        </ul>
    </nav>
    
    <!-- Overlay for mobile menu -->
    <div id="sidebar-overlay" class="hidden md:hidden fixed inset-0 bg-black opacity-50 z-20"></div>

    <!-- Main Content Area -->
    <main id="main-content" class="flex-1 p-4 md:p-10 overflow-y-auto">
      <div id="loading-state" class="text-center py-12">Connecting to database...</div>

      <!-- Dashboard Page -->
      <div id="dashboard-page" class="page-content">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white mb-4 md:mb-0">Dashboard</h2>
            <div class="flex items-center space-x-2 w-full md:w-auto">
                <button onclick="openExportModal()" class="w-full md:w-auto bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                    <i class="fas fa-file-excel mr-2"></i>Export Report
                </button>
                <button id="theme-toggle-main" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none md:hidden">
                    <i class="fas fa-moon text-gray-500 dark:text-gray-400"></i>
                    <i class="fas fa-sun text-gray-500 dark:text-gray-400 hidden"></i>
                </button>
            </div>
        </div>
        
        <!-- Overall Summary -->
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm flex items-center space-x-4">
                <div class="bg-blue-100 dark:bg-blue-900/50 p-4 rounded-full"><i class="fas fa-hdd text-2xl text-blue-500"></i></div>
                <div><p class="text-sm text-gray-500 dark:text-gray-400">Total Devices</p><p id="stat-total-devices" class="text-3xl font-bold text-gray-900 dark:text-white">0</p></div>
            </div>
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm flex items-center space-x-4">
                <div class="bg-yellow-100 dark:bg-yellow-900/50 p-4 rounded-full"><i class="fas fa-user-clock text-2xl text-yellow-500"></i></div>
                <div><p class="text-sm text-gray-500 dark:text-gray-400">On Loan</p><p id="stat-total-onloan" class="text-3xl font-bold text-gray-900 dark:text-white">0</p></div>
            </div>
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm flex items-center space-x-4">
                <div class="bg-orange-100 dark:bg-orange-900/50 p-4 rounded-full"><i class="fas fa-tools text-2xl text-orange-500"></i></div>
                <div><p class="text-sm text-gray-500 dark:text-gray-400">In Repair</p><p id="stat-total-repair" class="text-3xl font-bold text-gray-900 dark:text-white">0</p></div>
            </div>
             <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm flex items-center space-x-4">
                <div class="bg-gray-100 dark:bg-gray-700/50 p-4 rounded-full"><i class="fas fa-box-open text-2xl text-gray-500"></i></div>
                <div><p class="text-sm text-gray-500 dark:text-gray-400">In Storage</p><p id="stat-total-storage" class="text-3xl font-bold text-gray-900 dark:text-white">0</p></div>
            </div>
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm flex items-center space-x-4">
                <div class="bg-pink-100 dark:bg-pink-900/50 p-4 rounded-full"><i class="fas fa-heart-broken text-2xl text-pink-500"></i></div>
                <div><p class="text-sm text-gray-500 dark:text-gray-400">Damaged</p><p id="stat-total-damaged" class="text-3xl font-bold text-gray-900 dark:text-white">0</p></div>
            </div>
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm flex items-center space-x-4">
                <div class="bg-red-100 dark:bg-red-900/50 p-4 rounded-full"><i class="fas fa-trash-alt text-2xl text-red-500"></i></div>
                <div><p class="text-sm text-gray-500 dark:text-gray-400">Disposed</p><p id="stat-total-disposed" class="text-3xl font-bold text-gray-900 dark:text-white">0</p></div>
            </div>
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm flex items-center space-x-4 col-span-1 md:col-span-2">
                <div class="bg-red-100 dark:bg-red-900/50 p-4 rounded-full"><i class="fas fa-exclamation-triangle text-2xl text-red-500"></i></div>
                <div><p class="text-sm text-gray-500 dark:text-gray-400">Warranty Ending Soon (30 days)</p><p id="stat-total-warranty-ending" class="text-3xl font-bold text-gray-900 dark:text-white">0</p></div>
            </div>
        </div>

        <!-- KPI Cards by Category -->
        <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-4">Category Overview</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
            <!-- Computers -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm">
                <details class="group">
                    <summary class="flex items-center justify-between cursor-pointer">
                        <div class="flex items-center space-x-4">
                            <div class="bg-indigo-100 dark:bg-indigo-900/50 p-3 rounded-full"><i class="fas fa-laptop text-2xl text-indigo-500"></i></div>
                            <div>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Total Computers</p>
                                <p id="cat-total-computers" class="text-2xl font-bold text-gray-900 dark:text-white">0</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-down text-gray-400 transform group-open:rotate-180 transition-transform"></i>
                    </summary>
                    <div id="computer-type-breakdown" class="mt-4 pt-4 border-t dark:border-gray-700 space-y-4">
                        <!-- Breakdown will be injected here by JS -->
                    </div>
                </details>
            </div>
            <!-- Monitors -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm">
                <details class="group">
                    <summary class="flex items-center justify-between cursor-pointer">
                        <div class="flex items-center space-x-4">
                            <div class="bg-green-100 dark:bg-green-900/50 p-3 rounded-full"><i class="fas fa-desktop text-2xl text-green-500"></i></div>
                            <div>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Total Monitors</p>
                                <p id="cat-total-monitors" class="text-2xl font-bold text-gray-900 dark:text-white">0</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-down text-gray-400 transform group-open:rotate-180 transition-transform"></i>
                    </summary>
                    <div class="space-y-2 text-sm pt-4 border-t dark:border-gray-700 mt-4">
                        <div class="flex justify-between"><span class="text-green-500">Active:</span><span id="cat-monitors-active" class="font-medium text-green-500">0</span></div>
                        <div class="flex justify-between"><span class="text-yellow-500">On Loan:</span><span id="cat-monitors-on-loan" class="font-medium text-yellow-500">0</span></div>
                        <div class="flex justify-between"><span class="text-orange-500">Repair:</span><span id="cat-monitors-repair" class="font-medium text-orange-500">0</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Storage:</span><span id="cat-monitors-storage" class="font-medium text-gray-500">0</span></div>
                        <div class="flex justify-between"><span class="text-pink-500">Damaged:</span><span id="cat-monitors-damaged" class="font-medium text-pink-500">0</span></div>
                        <div class="flex justify-between"><span class="text-red-500">Disposed:</span><span id="cat-monitors-disposed" class="font-medium text-red-500">0</span></div>
                    </div>
                </details>
            </div>
            <!-- Audio -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm">
                <details class="group">
                    <summary class="flex items-center justify-between cursor-pointer">
                        <div class="flex items-center space-x-4">
                            <div class="bg-red-100 dark:bg-red-900/50 p-3 rounded-full"><i class="fas fa-volume-up text-2xl text-red-500"></i></div>
                            <div>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Total Audio</p>
                                <p id="cat-total-audio" class="text-2xl font-bold text-gray-900 dark:text-white">0</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-down text-gray-400 transform group-open:rotate-180 transition-transform"></i>
                    </summary>
                    <div class="space-y-2 text-sm pt-4 border-t dark:border-gray-700 mt-4">
                        <div class="flex justify-between"><span class="text-green-500">Active:</span><span id="cat-audio-active" class="font-medium text-green-500">0</span></div>
                        <div class="flex justify-between"><span class="text-yellow-500">On Loan:</span><span id="cat-audio-on-loan" class="font-medium text-yellow-500">0</span></div>
                        <div class="flex justify-between"><span class="text-orange-500">Repair:</span><span id="cat-audio-repair" class="font-medium text-orange-500">0</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Storage:</span><span id="cat-audio-storage" class="font-medium text-gray-500">0</span></div>
                        <div class="flex justify-between"><span class="text-pink-500">Damaged:</span><span id="cat-audio-damaged" class="font-medium text-pink-500">0</span></div>
                        <div class="flex justify-between"><span class="text-red-500">Disposed:</span><span id="cat-audio-disposed" class="font-medium text-red-500">0</span></div>
                    </div>
                </details>
            </div>
            <!-- Accessories -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm">
                <details class="group">
                    <summary class="flex items-center justify-between cursor-pointer">
                        <div class="flex items-center space-x-4">
                            <div class="bg-purple-100 dark:bg-purple-900/50 p-3 rounded-full"><i class="fas fa-keyboard text-2xl text-purple-500"></i></div>
                            <div>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Total Accessories</p>
                                <p id="cat-total-accessories" class="text-2xl font-bold text-gray-900 dark:text-white">0</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-down text-gray-400 transform group-open:rotate-180 transition-transform"></i>
                    </summary>
                    <div id="accessory-type-breakdown" class="mt-4 pt-4 border-t dark:border-gray-700 space-y-4">
                        <!-- Breakdown will be injected here by JS -->
                    </div>
                </details>
            </div>
        </div>
        
        <!-- Charts and Activities -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm">
                <h3 class="font-semibold text-lg mb-4 text-gray-900 dark:text-white">Device Status Distribution</h3>
                <canvas id="statusChart"></canvas>
            </div>
            <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm">
                 <h3 class="font-semibold text-lg mb-4 text-gray-900 dark:text-white">Recent Activities</h3>
                 <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">Device</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">Activity</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">User</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">Date</th>
                            </tr>
                        </thead>
                        <tbody id="recent-activities-table" class="divide-y divide-gray-200 dark:divide-gray-700"></tbody>
                    </table>
                 </div>
            </div>
        </div>

        <!-- Upcoming Return Deadlines -->
        <div class="mt-8 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm">
            <h3 class="font-semibold text-lg mb-4 text-gray-900 dark:text-white">Upcoming Return Deadlines (Next 2 Days)</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">Borrower</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">Device</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">Return Date</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">Time Left</th>
                        </tr>
                    </thead>
                    <tbody id="due-soon-table" class="divide-y divide-gray-200 dark:divide-gray-700"></tbody>
                </table>
            </div>
        </div>

        <!-- Warranty Watchlist -->
        <div class="mt-8 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm">
            <h3 class="font-semibold text-lg mb-4 text-gray-900 dark:text-white">Warranty Watchlist (Ending in 30 days)</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">Device Name</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">Serial Number</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">Category</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">Expires On</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">Days Left</th>
                        </tr>
                    </thead>
                    <tbody id="warranty-watchlist-table" class="divide-y divide-gray-200 dark:divide-gray-700"></tbody>
                </table>
            </div>
        </div>
      </div>

      <!-- Inventory Pages -->
      <div id="computers-page" class="page-content">
        <div class="flex justify-between items-center mb-6"><h2 class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white">Computer Inventory</h2><button onclick="openModal('add', 'Computers')" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700"><i class="fas fa-plus mr-2"></i>Add New</button></div>
        <div class="mb-4"><input type="text" id="computersSearchInput" onkeyup="handleSearch('Computers', this.value)" placeholder="Search computers..." class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400"></div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm overflow-hidden"><div class="overflow-x-auto"><table id="ComputersTable" class="min-w-full table-fixed"></table></div></div>
        <div id="ComputersPagination" class="flex items-center justify-between mt-4 text-sm text-gray-600 dark:text-gray-300"></div>
      </div>
      <div id="monitors-page" class="page-content">
        <div class="flex justify-between items-center mb-6"><h2 class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white">Monitor Inventory</h2><button onclick="openModal('add', 'Monitors')" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700"><i class="fas fa-plus mr-2"></i>Add New</button></div>
        <div class="mb-4"><input type="text" id="monitorsSearchInput" onkeyup="handleSearch('Monitors', this.value)" placeholder="Search monitors..." class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400"></div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm overflow-hidden"><div class="overflow-x-auto"><table id="MonitorsTable" class="min-w-full table-fixed"></table></div></div>
        <div id="MonitorsPagination" class="flex items-center justify-between mt-4 text-sm text-gray-600 dark:text-gray-300"></div>
      </div>
      <div id="audio-page" class="page-content">
        <div class="flex justify-between items-center mb-6"><h2 class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white">Audio Inventory</h2><button onclick="openModal('add', 'Audio')" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700"><i class="fas fa-plus mr-2"></i>Add New</button></div>
        <div class="mb-4"><input type="text" id="audioSearchInput" onkeyup="handleSearch('Audio', this.value)" placeholder="Search audio..." class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400"></div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm overflow-hidden"><div class="overflow-x-auto"><table id="AudioTable" class="min-w-full table-fixed"></table></div></div>
        <div id="AudioPagination" class="flex items-center justify-between mt-4 text-sm text-gray-600 dark:text-gray-300"></div>
      </div>
      <div id="accessory-page" class="page-content">
        <div class="flex justify-between items-center mb-6"><h2 class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white">Accessory Inventory</h2><button onclick="openModal('add', 'Accessory')" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700"><i class="fas fa-plus mr-2"></i>Add New</button></div>
        <div class="mb-4"><input type="text" id="accessorySearchInput" onkeyup="handleSearch('Accessory', this.value)" placeholder="Search accessories..." class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400"></div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm overflow-hidden"><div class="overflow-x-auto"><table id="AccessoryTable" class="min-w-full table-fixed"></table></div></div>
        <div id="AccessoryPagination" class="flex items-center justify-between mt-4 text-sm text-gray-600 dark:text-gray-300"></div>
      </div>
      
      <!-- Software Page -->
      <div id="software-page" class="page-content">
        <div class="flex justify-between items-center mb-6"><h2 class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white">Software Inventory</h2></div>
        <div class="mb-4"><input type="text" id="softwareSearchInput" onkeyup="filterSoftwareCards(this.value)" placeholder="Search by computer or software..." class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400"></div>
        <div id="SoftwareContainer" class="space-y-3"></div>
      </div>

      <!-- Loan History Page -->
       <div id="loanhistory-page" class="page-content">
        <div class="flex justify-between items-center mb-6"><h2 class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white">ประวัติการยืม-คืน</h2></div>
        <div class="mb-4"><input type="text" id="loanHistorySearchInput" onkeyup="filterLoanHistory(this.value)" placeholder="Search by borrower, serial, etc..." class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400"></div>
        <div id="LoanHistoryContainer" class="space-y-3"></div>
      </div>

    </main>
  </div>

  <!-- Modals -->
  <div id="editModal" class="modal pointer-events-none fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 opacity-0"><div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-md"><h3 id="editModalTitle" class="text-xl font-semibold mb-6"></h3><form id="editForm" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2"></form><div class="mt-6 flex justify-end space-x-4"><button onclick="hideModal('editModal')" class="px-6 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500">Cancel</button><button onclick="saveData()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Save</button></div></div></div>
  <div id="qrModal" class="modal pointer-events-none fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 opacity-0"><div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 text-center"><h3 id="qrModalTitle" class="text-xl font-semibold mb-4"></h3><canvas id="qrCanvas" class="mx-auto"></canvas><button onclick="hideModal('qrModal')" class="mt-6 px-6 py-2 bg-indigo-600 text-white rounded-lg">Close</button></div></div>
  <div id="exportModal" class="modal pointer-events-none fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 opacity-0">
    <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-lg">
        <h3 class="text-xl font-semibold mb-6">Export Data to CSV</h3>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Select categories to export:</label>
                <div id="export-categories-container" class="grid grid-cols-2 gap-4">
                    <!-- Checkboxes will be inserted here by JS -->
                </div>
            </div>
        </div>
        <div class="mt-6 flex justify-end space-x-4">
            <button onclick="hideModal('exportModal')" class="px-6 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500">Cancel</button>
            <button onclick="exportToCsv()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Download CSV</button>
        </div>
    </div>
  </div>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, addDoc, setDoc, deleteDoc, writeBatch, serverTimestamp, getDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyAqZ-xhY6WtIu4CEMOZqITWvqlnc5vF4Ew", authDomain: "inventory-eedef.firebaseapp.com", projectId: "inventory-eedef", storageBucket: "inventory-eedef.appspot.com", messagingSenderId: "1089383656081", appId: "1:1089383656081:web:bb8e8237a701f356102d30" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let allData = { Computers: [], Monitors: [], Audio: [], LoanHistory: [], Software: [], Location: [], Accessory: [] };
    let currentEdit = { mode: null, collection: null, id: null };
    let statusChart;
    let paginationState = {};

    const collectionConfigs = {
        Computers: { 
            headers: ['ComputerName', 'SerialNumber', 'UserName', 'Status', 'Type', 'Location'], 
            formFields: ['ComputerName', 'Manufacturer', 'Model', 'SerialNumber', 'UserName', 'Status', 'Type', 'Location', 'WarrantyStartDate', 'WarrantyEndDate'], 
            nameField: 'ComputerName', 
            serialField: 'SerialNumber', 
            icon: 'fa-laptop',
            categoryFilterField: 'Type',
            dropdowns: {
                Status: ['Active', 'On Loan', 'Repair', 'Storage', 'Damaged', 'Disposed'],
                Type: ['Desktop', 'Laptop', 'MacBook', 'POS']
            }
        },
        Monitors: { 
            headers: ['ComputerName', 'Model', 'MonitorSerial', 'Status'], 
            formFields: ['ComputerName', 'Model', 'MonitorSerial', 'Status', 'WarrantyStartDate', 'WarrantyEndDate'], 
            nameField: 'Model', 
            serialField: 'MonitorSerial', 
            icon: 'fa-desktop',
            dropdowns: {
                Status: ['Active', 'On Loan', 'Repair', 'Storage', 'Damaged', 'Disposed']
            }
        },
        Audio: { 
            headers: ['ItemName', 'Model', 'SerialNumber', 'Status'], 
            formFields: ['ItemName', 'Manufacturer', 'Model', 'SerialNumber', 'Status', 'WarrantyStartDate', 'WarrantyEndDate'], 
            nameField: 'ItemName', 
            serialField: 'SerialNumber', 
            icon: 'fa-volume-up',
            dropdowns: {
                Status: ['Active', 'On Loan', 'Repair', 'Storage', 'Damaged', 'Disposed']
            }
        },
        Accessory: {
            headers: ['AccessoryType', 'Model', 'SerialNumber', 'Status', 'UserName'],
            formFields: ['AccessoryType', 'Manufacturer', 'Model', 'SerialNumber', 'Status', 'AssignedComputer', 'UserName', 'WarrantyEndDate'],
            nameField: 'Model',
            serialField: 'SerialNumber',
            icon: 'fa-keyboard',
            categoryFilterField: 'AccessoryType',
            dropdowns: {
                Status: ['Active', 'On Loan', 'Repair', 'Storage', 'Damaged', 'Disposed'],
                AccessoryType: ['Mouse', 'Keyboard', 'Webcam', 'Docking Station', 'Adapter', 'UPS', 'Other']
            }
        }
    };

    // --- Mobile Navigation ---
    const sidebar = document.getElementById('sidebar');
    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const sidebarOverlay = document.getElementById('sidebar-overlay');

    function toggleMobileNav() {
        sidebar.classList.toggle('-translate-x-full');
        sidebarOverlay.classList.toggle('hidden');
    }
    mobileMenuButton.addEventListener('click', toggleMobileNav);
    sidebarOverlay.addEventListener('click', toggleMobileNav);


    window.loadPage = (pageName, navElement, filterValue = null) => {
        document.querySelectorAll('.nav-link, .nav-link-sub').forEach(link => link.classList.remove('active'));
        if (navElement) {
            navElement.classList.add('active');
            const parentDetails = navElement.closest('details');
            if (parentDetails) {
                parentDetails.querySelector('summary').classList.add('active');
            }
        }
        
        document.querySelectorAll('.page-content').forEach(page => page.style.display = 'none');
        const pageId = pageName.toLowerCase() + '-page';
        document.getElementById(pageId).style.display = 'block';
        
        if (pageName === 'Software') {
            buildSoftwareCards(allData.Software);
        } else if (collectionConfigs[pageName]) {
            const state = paginationState[pageName];
            state.categoryFilter = filterValue; // Set category filter from submenu
            state.filterText = ''; // Reset search text
            state.currentPage = 1; // Reset to page 1

            const searchInputId = `${pageName.toLowerCase()}SearchInput`;
            const searchInput = document.getElementById(searchInputId);
            if (searchInput) {
                searchInput.value = '';
            }
            
            buildTable(pageName);
        }

        if (window.innerWidth < 768) {
            toggleMobileNav();
        }
    };

    function buildTable(collectionName, errorMessage = null) {
        const table = document.getElementById(collectionName + 'Table');
        if (!table) return;

        const state = paginationState[collectionName];
        const fullData = allData[collectionName] || [];

        // Apply category filter first
        let categoryFilteredData = fullData;
        const config = collectionConfigs[collectionName];
        if (state.categoryFilter && config.categoryFilterField) {
            categoryFilteredData = fullData.filter(item => item[config.categoryFilterField] === state.categoryFilter);
        }

        // Then apply search filter
        const searchFilter = state.filterText.toUpperCase();
        const finalFilteredData = searchFilter
            ? categoryFilteredData.filter(item => JSON.stringify(Object.values(item)).toUpperCase().includes(searchFilter))
            : categoryFilteredData;

        const totalRows = finalFilteredData.length;
        const startIndex = (state.currentPage - 1) * state.rowsPerPage;
        const endIndex = startIndex + state.rowsPerPage;
        const paginatedData = finalFilteredData.slice(startIndex, endIndex);

        table.innerHTML = ''; // Clear existing table content
        const { headers, nameField, serialField } = config;
        const displayHeaders = [...headers, 'Actions'];
        const thead = document.createElement('thead');
        thead.className = 'bg-gray-50 dark:bg-gray-700';
        thead.innerHTML = `<tr>${displayHeaders.map(h => `<th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase tracking-wider">${h}</th>`).join('')}</tr>`;
        table.appendChild(thead);
        const tbody = document.createElement('tbody');
        tbody.className = 'divide-y divide-gray-200 dark:divide-gray-700';
        
        if (errorMessage) {
            tbody.innerHTML = `<tr><td class="px-6 py-4 text-center text-red-600" colspan="${displayHeaders.length}">${errorMessage}</td></tr>`;
        } else if (paginatedData.length === 0) {
            tbody.innerHTML = `<tr><td class="px-6 py-4 text-center text-gray-500 dark:text-gray-400" colspan="${displayHeaders.length}">No data found.</td></tr>`;
        } else {
            paginatedData.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors";
                headers.forEach(header => {
                    const rawValue = item[header] || '';
                    let cellValue = rawValue;
                    
                    if (header === 'WarrantyEndDate' && item.WarrantyEndDate) {
                        const endDate = new Date(item.WarrantyEndDate);
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);

                        if (!isNaN(endDate)) {
                            const diffTime = endDate - today;
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                            
                            let colorClass = '';
                            let daysText = '';
                            if (diffDays < 0) {
                                colorClass = 'text-red-500';
                                daysText = '(Expired)';
                            } else if (diffDays <= 30) {
                                colorClass = 'text-yellow-500';
                                daysText = `(${diffDays} days left)`;
                            } else {
                                colorClass = 'text-green-500';
                                daysText = `(${diffDays} days left)`;
                            }
                            cellValue = `<span>${rawValue} <span class="${colorClass} text-xs">${daysText}</span></span>`;
                        }
                    }

                    let extraClasses = 'whitespace-nowrap';
                    if (header === 'ComputerName' || header === 'ItemName' || header === 'Model' || header === 'UserName' || header === 'Location') {
                        extraClasses = 'truncate'; 
                    }
                    
                    tr.innerHTML += `<td class="px-6 py-4 text-sm text-gray-700 dark:text-gray-200 ${extraClasses}" title="${rawValue}">${cellValue}</td>`;
                });
                tr.innerHTML += `<td class="px-6 py-4 text-sm font-medium space-x-4 whitespace-nowrap"><button onclick="openModal('edit', '${collectionName}', '${item.id}')" class="text-indigo-600 hover:text-indigo-800 dark:text-indigo-400 dark:hover:text-indigo-300"><i class="fas fa-edit"></i></button><button onclick="deleteItem('${collectionName}', '${item.id}')" class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300"><i class="fas fa-trash"></i></button><button onclick="showQrModal('${item[serialField]}', '${item[nameField]}', 'device')" class="text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200"><i class="fas fa-qrcode"></i></button></td>`;
                tbody.appendChild(tr);
            });
        }
        table.appendChild(tbody);
        renderPaginationControls(collectionName, totalRows);
    }

    function renderPaginationControls(collectionName, totalRows) {
        const container = document.getElementById(collectionName + 'Pagination');
        if (!container) return;

        const state = paginationState[collectionName];
        const totalPages = Math.ceil(totalRows / state.rowsPerPage);
        const startItem = totalRows > 0 ? (state.currentPage - 1) * state.rowsPerPage + 1 : 0;
        const endItem = Math.min(startItem + state.rowsPerPage - 1, totalRows);

        container.innerHTML = `
            <div class="text-sm text-gray-700 dark:text-gray-300">
                Showing <span class="font-semibold">${startItem}</span> to <span class="font-semibold">${endItem}</span> of <span class="font-semibold">${totalRows}</span> results
            </div>
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2">
                    <label for="${collectionName}RowsPerPage" class="text-sm font-medium">Rows per page:</label>
                    <select id="${collectionName}RowsPerPage" onchange="changeRowsPerPage('${collectionName}', this)" class="rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 text-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="10" ${state.rowsPerPage == 10 ? 'selected' : ''}>10</option>
                        <option value="25" ${state.rowsPerPage == 25 ? 'selected' : ''}>25</option>
                        <option value="50" ${state.rowsPerPage == 50 ? 'selected' : ''}>50</option>
                    </select>
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="changePage('${collectionName}', -1)" ${state.currentPage === 1 ? 'disabled' : ''} class="px-3 py-1 border rounded-md disabled:opacity-50 disabled:cursor-not-allowed bg-white dark:bg-gray-700 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600"><i class="fas fa-chevron-left text-xs"></i></button>
                    <span class="text-sm font-medium">Page ${state.currentPage} of ${totalPages > 0 ? totalPages : 1}</span>
                    <button onclick="changePage('${collectionName}', 1)" ${state.currentPage >= totalPages ? 'disabled' : ''} class="px-3 py-1 border rounded-md disabled:opacity-50 disabled:cursor-not-allowed bg-white dark:bg-gray-700 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600"><i class="fas fa-chevron-right text-xs"></i></button>
                </div>
            </div>
        `;
    }

    window.changePage = (collectionName, direction) => {
        const state = paginationState[collectionName];
        const newPage = state.currentPage + direction;
        state.currentPage = newPage;
        buildTable(collectionName);
    };

    window.changeRowsPerPage = (collectionName, selectElement) => {
        const state = paginationState[collectionName];
        state.rowsPerPage = parseInt(selectElement.value, 10);
        state.currentPage = 1; // Reset to first page
        buildTable(collectionName);
    };

    window.handleSearch = (collectionName, filterText) => {
        const state = paginationState[collectionName];
        state.filterText = filterText;
        state.currentPage = 1; // Reset to page 1 on new search
        buildTable(collectionName);
    };

    function buildLoanHistoryCards(data, errorMessage = null) {
        const container = document.getElementById('LoanHistoryContainer');
        if (!container) return;
        container.innerHTML = '';

        if (errorMessage) {
            container.innerHTML = `<p class="text-center py-10 text-red-600">${errorMessage}</p>`;
            return;
        }
        if (data.length === 0) {
            container.innerHTML = `<p class="text-center py-10 text-gray-500 dark:text-gray-400">No loan history found.</p>`;
            return;
        }

        const groupedLoans = data.reduce((acc, loan) => {
            const groupId = loan.LoanGroupID;
            if (!acc[groupId]) {
                acc[groupId] = {
                    loanGroupId: groupId,
                    borrowerName: loan.BorrowerName,
                    loanDate: loan.LoanDate,
                    items: []
                };
            }
            acc[groupId].items.push(loan);
            return acc;
        }, {});

        const sortedGroups = Object.values(groupedLoans).sort((a, b) => {
            const dateA = a.loanDate?.toDate ? a.loanDate.toDate() : new Date(a.loanDate || 0);
            const dateB = b.loanDate?.toDate ? b.loanDate.toDate() : new Date(b.loanDate || 0);
            return dateB - dateA;
        });

        sortedGroups.forEach(group => {
            const allReturned = group.items.every(item => item.Status === 'Returned');
            const status = allReturned ? 'Returned' : 'On Loan';
            const loanDate = group.loanDate?.toDate ? group.loanDate.toDate().toLocaleDateString('th-TH') : 'N/A';
            const statusColor = status === 'On Loan' ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300' : 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300';
            
            const itemsHtml = group.items.map(item => {
                const returnDate = item.ReturnDate?.toDate ? item.ReturnDate.toDate().toLocaleDateString('th-TH') : '';
                return `<li class="flex justify-between items-center py-2 px-4 border-b dark:border-gray-700 last:border-b-0">
                            <div>
                                <p class="text-sm font-medium text-gray-800 dark:text-gray-200">${item.DeviceSerial} (${item.DeviceType})</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">Return Date: ${returnDate}</p>
                            </div>
                            <span class="text-xs font-semibold py-1 px-2.5 rounded-full ${item.Status === 'On Loan' ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300' : 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300'}">${item.Status}</span>
                        </li>`;
            }).join('');

            const actionButton = status === 'On Loan'
                ? `<button onclick="showQrModal('${group.loanGroupId}', 'Return QR for ${group.borrowerName}', 'return')" class="text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200 ml-4"><i class="fas fa-qrcode"></i></button>`
                : '';

            const card = document.createElement('div');
            card.className = "loan-card bg-white dark:bg-gray-800 rounded-lg shadow-sm overflow-hidden";
            card.innerHTML = `
                <details class="group" ${status === 'On Loan' ? 'open' : ''}>
                    <summary class="p-4 flex justify-between items-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                        <div>
                            <p class="borrower-name font-semibold text-lg text-gray-900 dark:text-white">${group.borrowerName}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Loan Date: ${loanDate} | ID: ${group.loanGroupId}</p>
                        </div>
                        <div class="flex items-center">
                            <span class="text-xs font-semibold py-1 px-2.5 rounded-full ${statusColor}">${status}</span>
                            ${actionButton}
                            <i class="fas fa-chevron-down text-gray-400 ml-4 transform group-open:rotate-180 transition-transform"></i>
                        </div>
                    </summary>
                    <div class="bg-gray-50 dark:bg-gray-900/50 border-t border-gray-200 dark:border-gray-700">
                        <ul>${itemsHtml}</ul>
                    </div>
                </details>
            `;
            container.appendChild(card);
        });
    }

    function buildSoftwareCards(softwareData, errorMessage = null) {
        const container = document.getElementById('SoftwareContainer');
        if (!container) return;
        container.innerHTML = '';
        if (errorMessage) {
            container.innerHTML = `<p class="text-center py-10 text-red-600">${errorMessage}</p>`;
            return;
        }
        if (!softwareData || softwareData.length === 0) {
            container.innerHTML = `<p class="text-center py-10 text-gray-500 dark:text-gray-400">No software data found.</p>`;
            return;
        }

        const groupedSoftware = softwareData.reduce((acc, sw) => {
            const computerName = sw.ComputerName;
            if (!acc[computerName]) {
                acc[computerName] = [];
            }
            acc[computerName].push(sw);
            return acc;
        }, {});

        Object.keys(groupedSoftware).sort().forEach(computerName => {
            const softwareList = groupedSoftware[computerName];
            const itemsHtml = softwareList.map(sw => `<li class="flex justify-between items-center py-2 px-4 border-b dark:border-gray-700 last:border-b-0 text-sm text-gray-800 dark:text-gray-300"><span>${sw.SoftwareName}</span><span>${sw.Version || ''}</span></li>`).join('');

            const card = document.createElement('div');
            card.className = "software-card bg-white dark:bg-gray-800 rounded-lg shadow-sm overflow-hidden";
            card.innerHTML = `
                <details class="group">
                    <summary class="p-4 flex justify-between items-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                        <div class="flex items-center">
                            <i class="fas fa-laptop text-indigo-500 mr-3"></i>
                            <span class="font-semibold text-gray-900 dark:text-white">${computerName}</span>
                            <span class="ml-2 text-xs bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 font-medium px-2 py-0.5 rounded-full">${softwareList.length} apps</span>
                        </div>
                        <i class="fas fa-chevron-down text-gray-400 transform group-open:rotate-180 transition-transform"></i>
                    </summary>
                    <div class="bg-gray-50 dark:bg-gray-900/50 border-t border-gray-200 dark:border-gray-700 max-h-72 overflow-y-auto">
                        <ul>${itemsHtml}</ul>
                    </div>
                </details>
            `;
            container.appendChild(card);
        });
    }
    
    window.filterLoanHistory = (filterText) => {
        const cards = document.querySelectorAll('#LoanHistoryContainer .loan-card');
        const filter = filterText.toUpperCase();
        cards.forEach(card => {
            card.style.display = card.textContent.toUpperCase().includes(filter) ? "" : "none";
        });
    };

    window.filterSoftwareCards = (filterText) => {
        const cards = document.querySelectorAll('#SoftwareContainer .software-card');
        const filter = filterText.toUpperCase();
        cards.forEach(card => {
            card.style.display = card.textContent.toUpperCase().includes(filter) ? "" : "none";
        });
    };


    window.openModal = (mode, collection, id = null) => {
        currentEdit = { mode, collection, id };
        const form = document.getElementById('editForm');
        form.innerHTML = '';
        const config = collectionConfigs[collection];
        const { formFields, dropdowns } = config;
        const itemData = (mode === 'edit') ? allData[collection].find(i => i.id === id) : {};
        document.getElementById('editModalTitle').textContent = `${mode === 'edit' ? 'Edit' : 'Add'} ${collection.slice(0, -1)}`;
        
        formFields.forEach(header => {
            const value = itemData[header] || '';
            let fieldHtml = `<div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300">${header}</label>`;
            
            if (header === 'Location' && allData.Location.length > 0) {
                fieldHtml += `
                    <div class="relative">
                        <input type="text" id="locationSearchInput" name="Location" value="${value}"
                               onkeyup="filterLocations(this.value)"
                               onfocus="document.getElementById('locationDropdown').classList.remove('hidden')"
                               placeholder="Search or select location..."
                               autocomplete="off"
                               class="mt-1 block w-full px-3 py-2 border rounded-md bg-white dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400">
                        <div id="locationDropdown" class="hidden absolute z-10 w-full bg-white dark:bg-gray-600 border dark:border-gray-500 rounded-md mt-1 max-h-48 overflow-y-auto shadow-lg">`;
                allData.Location.forEach(loc => {
                    fieldHtml += `<a href="#" data-value="${loc.LocationName}" class="location-item block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-500">${loc.LocationName}</a>`;
                });
                fieldHtml += `</div></div>`;
            } else if (header.toLowerCase().includes('date')) {
                fieldHtml += `<input type="date" name="${header}" value="${value}" class="mt-1 block w-full px-3 py-2 border rounded-md bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-300">`;
            } else if (dropdowns && dropdowns[header]) {
                const options = dropdowns[header];
                fieldHtml += `<select name="${header}" class="mt-1 block w-full px-3 py-2 border rounded-md bg-white dark:bg-gray-700 dark:border-gray-600">`;
                options.forEach(opt => {
                    const isSelected = value === opt ? 'selected' : '';
                    fieldHtml += `<option value="${opt}" ${isSelected}>${opt}</option>`;
                });
                fieldHtml += `</select>`;
            } else {
                fieldHtml += `<input type="text" name="${header}" value="${value}" class="mt-1 block w-full px-3 py-2 border rounded-md bg-white dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400">`;
            }
            fieldHtml += `</div>`;
            form.innerHTML += fieldHtml;
        });
        
        const locationDropdown = form.querySelector('#locationDropdown');
        if (locationDropdown) {
            form.querySelector('#locationSearchInput').addEventListener('blur', () => {
                setTimeout(() => locationDropdown.classList.add('hidden'), 200);
            });
            locationDropdown.addEventListener('click', (e) => {
                if (e.target.classList.contains('location-item')) {
                    e.preventDefault();
                    form.querySelector('#locationSearchInput').value = e.target.dataset.value;
                    locationDropdown.classList.add('hidden');
                }
            });
        }

        document.getElementById('editModal').classList.remove('opacity-0', 'pointer-events-none');
    };
    
    window.filterLocations = (filterText) => {
        const filter = filterText.toUpperCase();
        const dropdown = document.getElementById('locationDropdown');
        const items = dropdown.getElementsByTagName('a');
        for (let i = 0; i < items.length; i++) {
            const txtValue = items[i].textContent || items[i].innerText;
            items[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? "" : "none";
        }
    };

    window.hideModal = (modalId) => document.getElementById(modalId).classList.add('opacity-0', 'pointer-events-none');

    window.saveData = async () => {
        const formData = new FormData(document.getElementById('editForm'));
        const data = Object.fromEntries(formData.entries());
        const { mode, collection, id } = currentEdit;
        try {
            if (mode === 'edit') await setDoc(doc(db, collection, id), data, { merge: true });
            else await addDoc(collection(db, collection), data);
            hideModal('editModal');
        } catch (error) { console.error("Error:", error); alert("Failed to save."); }
    };

    window.deleteItem = async (collectionName, id) => {
        if (confirm(`Are you sure?`)) try { await deleteDoc(doc(db, collectionName, id)); } catch (error) { console.error("Error:", error); alert("Failed to delete."); }
    };

    window.showQrModal = (data, name, type) => {
        document.getElementById('qrModalTitle').textContent = `QR Code for ${name}`;
        let url;
        if (type === 'device') {
            url = `${window.location.origin}${window.location.pathname.replace('index.html', '')}details.html?sn=${data}`;
        } else { // type === 'return'
            url = `${window.location.origin}${window.location.pathname.replace('index.html', '')}return.html?id=${data}`;
        }
        QRCode.toCanvas(document.getElementById('qrCanvas'), url, { width: 256 });
        document.getElementById('qrModal').classList.remove('opacity-0', 'pointer-events-none');
    };

    function listenToCollection(collectionName, config) {
        onSnapshot(collection(db, collectionName), (snapshot) => {
            allData[collectionName] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (config.isInventory) {
                if(document.getElementById(`${collectionName.toLowerCase()}-page`).style.display === 'block') {
                    buildTable(collectionName);
                }
            } else if (collectionName === 'Software') {
                if(document.getElementById('software-page').style.display === 'block') {
                   buildSoftwareCards(allData[collectionName]);
                }
            } else if (collectionName === 'LoanHistory') {
                 if(document.getElementById('loanhistory-page').style.display === 'block') {
                    buildLoanHistoryCards(allData[collectionName]);
                }
            }
            updateDashboard();
        }, (error) => {
            console.error(`Error listening to ${collectionName}: `, error);
            let msg = `Error fetching data for ${collectionName}.`;
            if (error.code === 'permission-denied') msg = `Permission Denied. Check Firestore Rules.`;
            if (config.isInventory) buildTable(collectionName, [], msg);
            else if (collectionName === 'LoanHistory') buildLoanHistoryCards([], msg);
            else if (collectionName === 'Software') buildSoftwareCards([], msg);
        });
    }
    
    function updateDashboard() {
        const computers = allData['Computers'] || [];
        const monitors = allData['Monitors'] || [];
        const audio = allData['Audio'] || [];
        const accessories = allData['Accessory'] || [];
        const allDevices = [...computers, ...monitors, ...audio, ...accessories];
        const loanHistory = allData['LoanHistory'] || [];

        const getCountByStatus = (data, status) => data.filter(d => d.Status === status).length;
        
        const today = new Date();
        today.setHours(0,0,0,0); // Normalize to start of today
        
        const thirtyDaysFromNow = new Date(today);
        thirtyDaysFromNow.setDate(today.getDate() + 30);
        
        const warrantyEndingSoon = allDevices.filter(d => {
            if (!d.WarrantyEndDate) return false;
            const endDate = new Date(d.WarrantyEndDate);
            return endDate >= today && endDate <= thirtyDaysFromNow;
        });

        const twoDaysFromNow = new Date(today);
        twoDaysFromNow.setDate(today.getDate() + 2);
        twoDaysFromNow.setHours(23, 59, 59, 999); // Normalize to end of the day

        const dueSoonItems = loanHistory.filter(loan => {
            if (loan.Status !== 'On Loan' || !loan.DueDate?.toDate) {
                return false;
            }
            const dueDate = loan.DueDate.toDate();
            return dueDate >= today && dueDate <= twoDaysFromNow;
        });

        document.getElementById('stat-total-devices').textContent = allDevices.length;
        document.getElementById('stat-total-onloan').textContent = getCountByStatus(allDevices, 'On Loan');
        document.getElementById('stat-total-repair').textContent = getCountByStatus(allDevices, 'Repair');
        document.getElementById('stat-total-storage').textContent = getCountByStatus(allDevices, 'Storage');
        document.getElementById('stat-total-damaged').textContent = getCountByStatus(allDevices, 'Damaged');
        document.getElementById('stat-total-disposed').textContent = getCountByStatus(allDevices, 'Disposed');
        document.getElementById('stat-total-warranty-ending').textContent = warrantyEndingSoon.length;

        // Update Computer Card with Breakdown
        document.getElementById('cat-total-computers').textContent = computers.length;
        const computerTypes = collectionConfigs.Computers.dropdowns.Type;
        const computerBreakdownContainer = document.getElementById('computer-type-breakdown');
        computerBreakdownContainer.innerHTML = ''; 

        computerTypes.forEach(type => {
            const computersOfType = computers.filter(c => c.Type === type);
            if (computersOfType.length > 0) {
                const typeHtml = `
                    <div>
                        <h4 class="font-semibold text-md text-gray-700 dark:text-gray-300 mb-2">${type} (${computersOfType.length})</h4>
                        <div class="space-y-2 text-sm pl-2">
                            <div class="flex justify-between"><span class="text-green-500">Active:</span><span class="font-medium text-green-500">${getCountByStatus(computersOfType, 'Active')}</span></div>
                            <div class="flex justify-between"><span class="text-yellow-500">On Loan:</span><span class="font-medium text-yellow-500">${getCountByStatus(computersOfType, 'On Loan')}</span></div>
                            <div class="flex justify-between"><span class="text-orange-500">Repair:</span><span class="font-medium text-orange-500">${getCountByStatus(computersOfType, 'Repair')}</span></div>
                            <div class="flex justify-between"><span class="text-gray-500">Storage:</span><span class="font-medium text-gray-500">${getCountByStatus(computersOfType, 'Storage')}</span></div>
                            <div class="flex justify-between"><span class="text-pink-500">Damaged:</span><span class="font-medium text-pink-500">${getCountByStatus(computersOfType, 'Damaged')}</span></div>
                            <div class="flex justify-between"><span class="text-red-500">Disposed:</span><span class="font-medium text-red-500">${getCountByStatus(computersOfType, 'Disposed')}</span></div>
                        </div>
                    </div>
                `;
                computerBreakdownContainer.innerHTML += typeHtml;
            }
        });

        // Update Monitor Card
        document.getElementById('cat-total-monitors').textContent = monitors.length;
        document.getElementById('cat-monitors-active').textContent = getCountByStatus(monitors, 'Active');
        document.getElementById('cat-monitors-on-loan').textContent = getCountByStatus(monitors, 'On Loan');
        document.getElementById('cat-monitors-repair').textContent = getCountByStatus(monitors, 'Repair');
        document.getElementById('cat-monitors-storage').textContent = getCountByStatus(monitors, 'Storage');
        document.getElementById('cat-monitors-damaged').textContent = getCountByStatus(monitors, 'Damaged');
        document.getElementById('cat-monitors-disposed').textContent = getCountByStatus(monitors, 'Disposed');

        // Update Audio Card
        document.getElementById('cat-total-audio').textContent = audio.length;
        document.getElementById('cat-audio-active').textContent = getCountByStatus(audio, 'Active');
        document.getElementById('cat-audio-on-loan').textContent = getCountByStatus(audio, 'On Loan');
        document.getElementById('cat-audio-repair').textContent = getCountByStatus(audio, 'Repair');
        document.getElementById('cat-audio-storage').textContent = getCountByStatus(audio, 'Storage');
        document.getElementById('cat-audio-damaged').textContent = getCountByStatus(audio, 'Damaged');
        document.getElementById('cat-audio-disposed').textContent = getCountByStatus(audio, 'Disposed');

        // Update Accessory Card with Breakdown
        document.getElementById('cat-total-accessories').textContent = accessories.length;
        const accessoryTypes = collectionConfigs.Accessory.dropdowns.AccessoryType;
        const accessoryBreakdownContainer = document.getElementById('accessory-type-breakdown');
        accessoryBreakdownContainer.innerHTML = ''; 

        accessoryTypes.forEach(type => {
            const accessoriesOfType = accessories.filter(c => c.AccessoryType === type);
            if (accessoriesOfType.length > 0) {
                const typeHtml = `
                    <div>
                        <h4 class="font-semibold text-md text-gray-700 dark:text-gray-300 mb-2">${type} (${accessoriesOfType.length})</h4>
                        <div class="space-y-2 text-sm pl-2">
                            <div class="flex justify-between"><span class="text-green-500">Active:</span><span class="font-medium text-green-500">${getCountByStatus(accessoriesOfType, 'Active')}</span></div>
                            <div class="flex justify-between"><span class="text-yellow-500">On Loan:</span><span class="font-medium text-yellow-500">${getCountByStatus(accessoriesOfType, 'On Loan')}</span></div>
                            <div class="flex justify-between"><span class="text-orange-500">Repair:</span><span class="font-medium text-orange-500">${getCountByStatus(accessoriesOfType, 'Repair')}</span></div>
                            <div class="flex justify-between"><span class="text-gray-500">Storage:</span><span class="font-medium text-gray-500">${getCountByStatus(accessoriesOfType, 'Storage')}</span></div>
                            <div class="flex justify-between"><span class="text-pink-500">Damaged:</span><span class="font-medium text-pink-500">${getCountByStatus(accessoriesOfType, 'Damaged')}</span></div>
                            <div class="flex justify-between"><span class="text-red-500">Disposed:</span><span class="font-medium text-red-500">${getCountByStatus(accessoriesOfType, 'Disposed')}</span></div>
                        </div>
                    </div>
                `;
                accessoryBreakdownContainer.innerHTML += typeHtml;
            }
        });

        const statusCounts = allDevices.reduce((acc, device) => {
            if(device.Status) {
               acc[device.Status] = (acc[device.Status] || 0) + 1;
            }
            return acc;
        }, {});
        renderStatusChart(statusCounts);

        renderRecentActivities(loanHistory, allDevices);
        renderWarrantyWatchlist(warrantyEndingSoon);
        renderDueSoonTable(dueSoonItems, allDevices);
    }
    
    function renderStatusChart(statusData) {
        const ctx = document.getElementById('statusChart').getContext('2d');
        const labels = Object.keys(statusData);
        const data = Object.values(statusData);
        
        Chart.defaults.color = document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#6b7280';

        if (statusChart) {
            statusChart.data.labels = labels;
            statusChart.data.datasets[0].data = data;
            statusChart.update();
        } else {
            statusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Device Status',
                        data: data,
                        backgroundColor: ['#22C55E', '#F59E0B', '#F97316', '#3B82F6', '#EF4444', '#6B7280', '#EC4899'],
                        borderColor: document.documentElement.classList.contains('dark') ? '#1f2937' : '#ffffff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }
    }

    function renderRecentActivities(loanData, allDevices) {
        const tbody = document.getElementById('recent-activities-table');
        tbody.innerHTML = '';

        const activities = loanData.map(loan => {
            const activityDate = loan.ReturnDate ? loan.ReturnDate : loan.LoanDate;
            return {
                ...loan,
                activityType: loan.ReturnDate ? 'Return' : 'Loan',
                activityTimestamp: activityDate?.toDate ? activityDate.toDate() : new Date(0)
            };
        }).sort((a, b) => b.activityTimestamp - a.activityTimestamp).slice(0, 5);

        if (activities.length === 0) {
            tbody.innerHTML = `<tr><td colspan="4" class="text-center text-gray-500 dark:text-gray-400 py-4">No recent activity</td></tr>`;
            return;
        }

        activities.forEach(act => {
            const config = collectionConfigs[act.DeviceType];
            const device = allDevices.find(d => config && d[config.serialField] === act.DeviceSerial);
            const deviceName = device && config ? device[config.nameField] : act.DeviceSerial;
            
            const activityHtml = act.activityType === 'Loan'
                ? `<span class="font-semibold text-yellow-500">Loaned</span>`
                : `<span class="font-semibold text-green-500">Returned</span>`;

            tbody.innerHTML += `
                <tr class="text-sm">
                    <td class="px-4 py-2 font-medium text-gray-800 dark:text-gray-200">${deviceName}</td>
                    <td class="px-4 py-2">${activityHtml}</td>
                    <td class="px-4 py-2 text-gray-600 dark:text-gray-400">${act.BorrowerName}</td>
                    <td class="px-4 py-2 text-gray-600 dark:text-gray-400">${act.activityTimestamp.toLocaleDateString('th-TH')}</td>
                </tr>
            `;
        });
    }

    function renderWarrantyWatchlist(devices) {
        const tbody = document.getElementById('warranty-watchlist-table');
        tbody.innerHTML = '';
        if (devices.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500 dark:text-gray-400 py-4">No devices with warranty expiring soon.</td></tr>`;
            return;
        }
        
        const today = new Date();
        today.setHours(0,0,0,0);

        devices.forEach(device => {
            const config = Object.values(collectionConfigs).find(c => device[c.serialField]);
            const category = Object.keys(collectionConfigs).find(key => allData[key].some(d => d.id === device.id)) || 'N/A';
            const endDate = new Date(device.WarrantyEndDate);
            const diffTime = endDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            tbody.innerHTML += `
                <tr class="text-sm">
                    <td class="px-4 py-2 font-medium text-gray-800 dark:text-gray-200">${device[config.nameField]}</td>
                    <td class="px-4 py-2 text-gray-600 dark:text-gray-400">${device[config.serialField]}</td>
                    <td class="px-4 py-2 text-gray-600 dark:text-gray-400">${category}</td>
                    <td class="px-4 py-2 text-gray-600 dark:text-gray-400">${device.WarrantyEndDate}</td>
                    <td class="px-4 py-2 font-semibold text-red-500">${diffDays} days</td>
                </tr>
            `;
        });
    }

    function renderDueSoonTable(dueItems, allDevices) {
        const tbody = document.getElementById('due-soon-table');
        tbody.innerHTML = '';
        if (dueItems.length === 0) {
            tbody.innerHTML = `<tr><td colspan="4" class="text-center text-gray-500 dark:text-gray-400 py-4">No items are due for return soon.</td></tr>`;
            return;
        }

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        dueItems.sort((a,b) => a.DueDate.toDate() - b.DueDate.toDate());

        dueItems.forEach(item => {
            const config = collectionConfigs[item.DeviceType];
            const device = allDevices.find(d => config && d[config.serialField] === item.DeviceSerial);
            const deviceName = device && config ? device[config.nameField] : item.DeviceSerial;
            
            const dueDate = item.DueDate.toDate();
            const diffTime = dueDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            let daysLeftText = `${diffDays} days`;
            let textColor = 'text-yellow-500';

            if (diffDays <= 0) {
                daysLeftText = 'Due Today';
                textColor = 'text-red-500 animate-pulse';
            } else if (diffDays === 1) {
                daysLeftText = '1 day';
            }
            
            tbody.innerHTML += `
                <tr class="text-sm">
                    <td class="px-4 py-2 font-medium text-gray-800 dark:text-gray-200">${item.BorrowerName}</td>
                    <td class="px-4 py-2 text-gray-600 dark:text-gray-400">${deviceName}</td>
                    <td class="px-4 py-2 text-gray-600 dark:text-gray-400">${dueDate.toLocaleDateString('th-TH')}</td>
                    <td class="px-4 py-2 font-semibold ${textColor}">${daysLeftText}</td>
                </tr>
            `;
        });
    }
    
    // --- Export to CSV ---
    window.openExportModal = () => {
        const container = document.getElementById('export-categories-container');
        container.innerHTML = '';
        // Also add LoanHistory to the export options
        const exportableCollections = {...collectionConfigs, LoanHistory: {}};
        Object.keys(exportableCollections).forEach(collectionName => {
            container.innerHTML += `
                <label class="flex items-center space-x-3">
                    <input type="checkbox" name="export-category" value="${collectionName}" class="rounded text-indigo-600 focus:ring-indigo-500">
                    <span class="text-gray-700 dark:text-gray-300">${collectionName}</span>
                </label>
            `;
        });
        document.getElementById('exportModal').classList.remove('opacity-0', 'pointer-events-none');
    };

    window.exportToCsv = () => {
        const checkboxes = document.querySelectorAll('input[name="export-category"]:checked');
        if (checkboxes.length === 0) {
            alert('Please select at least one category to export.');
            return;
        }

        const selectedCategories = Array.from(checkboxes).map(cb => cb.value);

        // --- Create Summary ---
        let summaryCsvContent = 'Category Status Summary\n';
        const allStatuses = ['Active', 'On Loan', 'Repair', 'Storage', 'Damaged', 'Disposed'];
        summaryCsvContent += 'Category / Type,Total,' + allStatuses.join(',') + '\n';

        selectedCategories.forEach(cat => {
            if (cat === 'LoanHistory') return; 

            const categoryData = allData[cat] || [];
            const config = collectionConfigs[cat];
            
            // Check if the category has subtypes (like Computers -> Type, Accessory -> AccessoryType)
            if (config && config.categoryFilterField && config.dropdowns && config.dropdowns[config.categoryFilterField]) {
                const types = config.dropdowns[config.categoryFilterField];
                types.forEach(type => {
                    const typeData = categoryData.filter(item => item[config.categoryFilterField] === type);
                    if (typeData.length > 0) { // Only show types that have items
                        const counts = { Total: typeData.length };
                        allStatuses.forEach(status => {
                            counts[status] = typeData.filter(item => item.Status === status).length;
                        });
                        const rowName = `${cat} - ${type}`;
                        const row = [rowName, counts.Total, ...allStatuses.map(status => counts[status] || 0)].join(',');
                        summaryCsvContent += row + '\n';
                    }
                });
            } else {
                // For categories without subtypes (Monitors, Audio)
                const counts = { Total: categoryData.length };
                allStatuses.forEach(status => {
                    counts[status] = categoryData.filter(item => item.Status === status).length;
                });
                const row = [cat, counts.Total, ...allStatuses.map(status => counts[status] || 0)].join(',');
                summaryCsvContent += row + '\n';
            }
        });

        summaryCsvContent += '\n\nRaw Data\n'; // Add spacing before raw data

        // --- Aggregate Raw Data ---
        let dataToExport = [];
        selectedCategories.forEach(cat => {
            const categoryData = allData[cat] || [];
            const dataWithCategory = categoryData.map(item => {
                const cleanItem = {...item};
                // Convert Firestore Timestamps to readable dates
                Object.keys(cleanItem).forEach(key => {
                    if (cleanItem[key] && typeof cleanItem[key].toDate === 'function') {
                        cleanItem[key] = cleanItem[key].toDate().toLocaleString('th-TH');
                    }
                });
                return { Category: cat, ...cleanItem };
            });
            dataToExport.push(...dataWithCategory);
        });

        if (dataToExport.length === 0 && summaryCsvContent.split('\n').length <= 4) { // 4 lines = 2 headers + 2 newlines
            alert('No data available for the selected categories.');
            return;
        }

        // --- Create Raw Data CSV ---
        const headers = [...new Set(dataToExport.flatMap(obj => Object.keys(obj)))];
        const sanitizeCell = (cell) => {
            if (cell === null || cell === undefined) return '';
            let cellStr = String(cell);
            if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                cellStr = cellStr.replace(/"/g, '""');
                return `"${cellStr}"`;
            }
            return cellStr;
        };
        let dataCsvContent = headers.join(',') + '\n';
        dataToExport.forEach(item => {
            const row = headers.map(header => sanitizeCell(item[header])).join(',');
            dataCsvContent += row + '\n';
        });

        // --- Combine and Download ---
        const finalCsvContent = summaryCsvContent + dataCsvContent;
        const bom = new Uint8Array([0xEF, 0xBB, 0xBF]); // BOM for UTF-8
        const blob = new Blob([bom, finalCsvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        
        const date = new Date().toISOString().slice(0, 10);
        link.setAttribute("href", url);
        link.setAttribute("download", `inventory_report_${date}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        hideModal('exportModal');
    };

    // --- Theme Toggle ---
    const themeToggles = [document.getElementById('theme-toggle-desktop'), document.getElementById('theme-toggle-main')];

    function applyTheme(theme) {
        if (theme === 'dark') {
            document.documentElement.classList.add('dark');
            themeToggles.forEach(toggle => {
                if(toggle) {
                    toggle.querySelector('.fa-moon').classList.add('hidden');
                    toggle.querySelector('.fa-sun').classList.remove('hidden');
                }
            });
        } else {
            document.documentElement.classList.remove('dark');
            themeToggles.forEach(toggle => {
                if(toggle) {
                    toggle.querySelector('.fa-moon').classList.remove('hidden');
                    toggle.querySelector('.fa-sun').classList.add('hidden');
                }
            });
        }
        if (statusChart) {
            Chart.defaults.color = document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#6b7280';
            statusChart.options.plugins.legend.labels.color = document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#6b7280';
            statusChart.data.datasets[0].borderColor = document.documentElement.classList.contains('dark') ? '#1f2937' : '#ffffff';
            statusChart.update();
        }
    }

    themeToggles.forEach(btn => {
        if(btn) {
            btn.addEventListener('click', function() {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.setItem('color-theme', isDark ? 'dark' : 'light');
                applyTheme(isDark ? 'dark' : 'light');
            });
        }
    });

    window.addEventListener('load', () => {
        const savedTheme = localStorage.getItem('color-theme');
        const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        applyTheme(savedTheme || (systemPrefersDark ? 'dark' : 'light'));

        Object.keys(collectionConfigs).forEach(collectionName => {
            paginationState[collectionName] = {
                currentPage: 1,
                rowsPerPage: 10,
                filterText: '',
                categoryFilter: null
            };
        });

        listenToCollection('Computers', { isInventory: true });
        listenToCollection('Monitors', { isInventory: true });
        listenToCollection('Audio', { isInventory: true });
        listenToCollection('Software', { isInventory: false });
        listenToCollection('LoanHistory', { isInventory: false });
        listenToCollection('Location', { isInventory: false });
        listenToCollection('Accessory', { isInventory: true });
        document.getElementById('loading-state').style.display = 'none';
        loadPage('Dashboard', document.getElementById('nav-dashboard'));
    });
  </script>
</body>
</html>

