<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Inventory Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .page-content { display: none; }
    .nav-link.active { background-color: #4f46e5; color: white; font-weight: 600; }
    .nav-link:not(.active):hover { background-color: #f3f4f6; color: #1f2937; }
    .modal { transition: opacity 0.3s ease; }
    .modal-content { transition: all 0.3s ease; }
    .modal.opacity-0 .modal-content { transform: scale(0.95); }
    #qr-reader { border: 2px solid #e5e7eb; border-radius: 0.5rem; overflow: hidden; }
    .tab-button.active { border-color: #4f46e5; color: #4f46e5; background-color: #eef2ff; }
    .device-card.selected { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4); background-color: #eff6ff; }
    .device-card.selected .selected-icon { opacity: 1; }
    .selected-icon { opacity: 0; transition: opacity 0.2s ease-in-out; }
    #sidebar { transition: transform 0.3s ease-in-out; }
    details > summary { list-style: none; }
    details > summary::-webkit-details-marker { display: none; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <div class="relative min-h-screen md:flex">
    <!-- Mobile Menu Button -->
    <div class="md:hidden flex justify-between items-center bg-white p-4 border-b">
        <div class="flex items-center space-x-3">
            <i class="fas fa-cubes text-2xl text-indigo-600"></i>
            <h1 class="text-xl font-bold text-gray-800">Inventory</h1>
        </div>
        <button id="mobile-menu-button" class="text-gray-500 focus:outline-none">
            <i class="fas fa-bars text-2xl"></i>
        </button>
    </div>

    <!-- Sidebar Navigation -->
    <nav id="sidebar" class="w-64 bg-white border-r border-gray-200 p-5 flex flex-col flex-shrink-0 fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 z-30">
        <div class="flex items-center space-x-3 mb-10"><i class="fas fa-cubes text-2xl text-indigo-600"></i><h1 class="text-xl font-bold text-gray-800">Inventory</h1></div>
        <ul class="space-y-2">
            <li><a href="#" id="nav-dashboard" onclick="loadPage('Dashboard', this); return false;" class="nav-link flex items-center space-x-3 px-4 py-2.5 rounded-lg text-gray-600"><i class="fas fa-tachometer-alt w-5 text-center"></i><span>Dashboard</span></a></li>
            <li><a href="#" id="nav-computers" onclick="loadPage('Computers', this); return false;" class="nav-link flex items-center space-x-3 px-4 py-2.5 rounded-lg text-gray-600"><i class="fas fa-laptop w-5 text-center"></i><span>Computers</span></a></li>
            <li><a href="#" id="nav-monitors" onclick="loadPage('Monitors', this); return false;" class="nav-link flex items-center space-x-3 px-4 py-2.5 rounded-lg text-gray-600"><i class="fas fa-desktop w-5 text-center"></i><span>Monitors</span></a></li>
            <li><a href="#" id="nav-audio" onclick="loadPage('Audio', this); return false;" class="nav-link flex items-center space-x-3 px-4 py-2.5 rounded-lg text-gray-600"><i class="fas fa-volume-up w-5 text-center"></i><span>Audio</span></a></li>
            <li><a href="#" id="nav-software" onclick="loadPage('Software', this); return false;" class="nav-link flex items-center space-x-3 px-4 py-2.5 rounded-lg text-gray-600"><i class="fas fa-cogs w-5 text-center"></i><span>Software</span></a></li>
            <li class="pt-4"><div class="px-4 text-xs font-semibold uppercase text-gray-400">Management</div></li>
            <li><a href="#" id="nav-loan" onclick="loadPage('Loan', this); return false;" class="nav-link flex items-center space-x-3 px-4 py-2.5 rounded-lg text-gray-600"><i class="fas fa-exchange-alt w-5 text-center"></i><span>ยืม-คืน</span></a></li>
            <li><a href="#" id="nav-loanhistory" onclick="loadPage('LoanHistory', this); return false;" class="nav-link flex items-center space-x-3 px-4 py-2.5 rounded-lg text-gray-600"><i class="fas fa-history w-5 text-center"></i><span>ประวัติการยืม</span></a></li>
        </ul>
    </nav>
    
    <!-- Overlay for mobile menu -->
    <div id="sidebar-overlay" class="hidden md:hidden fixed inset-0 bg-black opacity-50 z-20"></div>

    <!-- Main Content Area -->
    <main id="main-content" class="flex-1 p-4 md:p-10 overflow-y-auto">
      <div id="loading-state" class="text-center py-12">Connecting to database...</div>

      <!-- Dashboard Page -->
      <div id="dashboard-page" class="page-content">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-4 md:mb-0">Dashboard</h2>
            <button onclick="resetAllStatusToActive()" class="w-full md:w-auto bg-orange-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors">
                <i class="fas fa-sync-alt mr-2"></i>Reset All Status
            </button>
        </div>
        <!-- KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-6 rounded-lg shadow-sm flex items-center space-x-4"><div class="bg-blue-100 p-4 rounded-full"><i class="fas fa-laptop text-2xl text-blue-500"></i></div><div><p class="text-sm text-gray-500">Total Computers</p><p id="stat-total-computers" class="text-2xl font-bold text-gray-900">0</p></div></div>
            <div class="bg-white p-6 rounded-lg shadow-sm flex items-center space-x-4"><div class="bg-green-100 p-4 rounded-full"><i class="fas fa-desktop text-2xl text-green-500"></i></div><div><p class="text-sm text-gray-500">Total Monitors</p><p id="stat-total-monitors" class="text-2xl font-bold text-gray-900">0</p></div></div>
            <div class="bg-white p-6 rounded-lg shadow-sm flex items-center space-x-4"><div class="bg-red-100 p-4 rounded-full"><i class="fas fa-volume-up text-2xl text-red-500"></i></div><div><p class="text-sm text-gray-500">Total Audio</p><p id="stat-total-audio" class="text-2xl font-bold text-gray-900">0</p></div></div>
            <div class="bg-white p-6 rounded-lg shadow-sm flex items-center space-x-4"><div class="bg-yellow-100 p-4 rounded-full"><i class="fas fa-exchange-alt text-2xl text-yellow-500"></i></div><div><p class="text-sm text-gray-500">Devices On Loan</p><p id="stat-total-onloan" class="text-2xl font-bold text-gray-900">0</p></div></div>
        </div>
        <!-- Charts and Recent Activity -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-sm">
                <h3 class="font-semibold text-lg mb-4">Device Status</h3>
                <canvas id="statusChart"></canvas>
            </div>
            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-sm">
                 <h3 class="font-semibold text-lg mb-4">Recent Loan Activity</h3>
                 <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Borrower</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Date</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Status</th>
                            </tr>
                        </thead>
                        <tbody id="recent-loans-table" class="divide-y divide-gray-200">
                            <!-- Recent loans will be inserted here -->
                        </tbody>
                    </table>
                 </div>
            </div>
        </div>
      </div>

      <!-- Inventory Pages -->
      <div id="computers-page" class="page-content"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl md:text-3xl font-bold text-gray-900">Computer Inventory</h2><button onclick="openModal('add', 'Computers')" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700"><i class="fas fa-plus mr-2"></i>Add New</button></div><div class="mb-4"><input type="text" onkeyup="filterTable('ComputersTable', this.value)" placeholder="Search computers..." class="w-full px-4 py-2 border rounded-lg"></div><div class="bg-white rounded-lg shadow-sm overflow-hidden"><div class="overflow-x-auto"><table id="ComputersTable" class="min-w-full"></table></div></div></div>
      <div id="monitors-page" class="page-content"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl md:text-3xl font-bold text-gray-900">Monitor Inventory</h2><button onclick="openModal('add', 'Monitors')" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700"><i class="fas fa-plus mr-2"></i>Add New</button></div><div class="mb-4"><input type="text" onkeyup="filterTable('MonitorsTable', this.value)" placeholder="Search monitors..." class="w-full px-4 py-2 border rounded-lg"></div><div class="bg-white rounded-lg shadow-sm overflow-hidden"><div class="overflow-x-auto"><table id="MonitorsTable" class="min-w-full"></table></div></div></div>
      <div id="audio-page" class="page-content"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl md:text-3xl font-bold text-gray-900">Audio Inventory</h2><button onclick="openModal('add', 'Audio')" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700"><i class="fas fa-plus mr-2"></i>Add New</button></div><div class="mb-4"><input type="text" onkeyup="filterTable('AudioTable', this.value)" placeholder="Search audio..." class="w-full px-4 py-2 border rounded-lg"></div><div class="bg-white rounded-lg shadow-sm overflow-hidden"><div class="overflow-x-auto"><table id="AudioTable" class="min-w-full"></table></div></div></div>
      
      <!-- Software Page -->
      <div id="software-page" class="page-content">
        <div class="flex justify-between items-center mb-6"><h2 class="text-2xl md:text-3xl font-bold text-gray-900">Software Inventory</h2></div>
        <div class="mb-4"><input type="text" id="softwareSearchInput" onkeyup="filterSoftwareCards(this.value)" placeholder="Search by computer or software..." class="w-full px-4 py-2 border rounded-lg"></div>
        <div id="SoftwareContainer" class="space-y-3"></div>
      </div>

      <!-- Loan Page -->
      <div id="loan-page" class="page-content">
        <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-6">ยืม-คืน อุปกรณ์</h2>
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
            <div class="lg:col-span-3 bg-white rounded-xl shadow-md p-6 space-y-4">
                <div class="mb-4 border-b border-gray-200"><nav class="flex -mb-px space-x-4"><button onclick="switchLoanTab('scan', this)" class="tab-button active flex items-center whitespace-nowrap py-3 px-2 border-b-2 font-medium text-sm"><i class="fas fa-camera mr-2"></i>สแกน QR Code</button><button onclick="switchLoanTab('select', this)" class="tab-button flex items-center whitespace-nowrap py-3 px-2 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700"><i class="fas fa-list-ul mr-2"></i>เลือกจากรายการ</button></nav></div>
                <div id="scan-view">
                    <div id="qr-reader" class="w-full max-w-sm mx-auto mb-2"></div>
                    <button id="start-scan-button" onclick="startScanning()" class="w-full mt-2 bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 flex items-center justify-center"><i class="fas fa-camera mr-2"></i>เริ่มการสแกน</button>
                </div>
                <div id="select-view" class="hidden space-y-6">
                    <div id="category-selection"></div>
                    <div id="device-list-view" class="hidden"><button onclick="showCategorySelection()" class="mb-4 text-sm text-blue-600 hover:underline"><i class="fas fa-arrow-left mr-2"></i>ย้อนกลับ</button><div id="device-list-container"></div></div>
                </div>
            </div>
            <div class="lg:col-span-2 bg-white rounded-xl shadow-md p-6">
                <h3 class="text-xl font-bold mb-4 text-gray-800">ตะกร้าการยืม</h3>
                <div id="cart" class="space-y-2 border p-3 rounded-md min-h-[120px] bg-gray-50 mb-6"><p class="text-sm text-gray-500">ยังไม่มีอุปกรณ์ในตะกร้า</p></div>
                <form id="loanForm" class="space-y-4">
                    <div><label class="block text-sm font-medium text-gray-700">ชื่อผู้ยืม</label><input type="text" id="borrowerName" required class="mt-1 block w-full px-3 py-2 border rounded-md"></div>
                    <div><label class="block text-sm font-medium text-gray-700">กำหนดคืน</label><input type="date" id="dueDate" required class="mt-1 block w-full px-3 py-2 border rounded-md"></div>
                    <div><label class="block text-sm font-medium text-gray-700">หมายเหตุ</label><textarea id="loanNotes" rows="2" class="mt-1 block w-full px-3 py-2 border rounded-md"></textarea></div>
                    <button type="button" onclick="submitLoan()" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">ยืนยันการยืม</button>
                </form>
            </div>
        </div>
      </div>

      <!-- Loan History Page -->
       <div id="loanhistory-page" class="page-content">
        <div class="flex justify-between items-center mb-6"><h2 class="text-2xl md:text-3xl font-bold text-gray-900">ประวัติการยืม-คืน</h2></div>
        <div class="mb-4"><input type="text" id="loanHistorySearchInput" onkeyup="filterLoanHistory(this.value)" placeholder="Search by borrower, serial, etc..." class="w-full px-4 py-2 border rounded-lg"></div>
        <div id="LoanHistoryContainer" class="space-y-3"></div>
      </div>

    </main>
  </div>

  <!-- Modals -->
  <div id="editModal" class="modal pointer-events-none fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 opacity-0"><div class="modal-content bg-white rounded-lg shadow-xl p-8 w-full max-w-md"><h3 id="editModalTitle" class="text-xl font-semibold mb-6"></h3><form id="editForm" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2"></form><div class="mt-6 flex justify-end space-x-4"><button onclick="hideModal('editModal')" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button><button onclick="saveData()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Save</button></div></div></div>
  <div id="qrModal" class="modal pointer-events-none fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 opacity-0"><div class="modal-content bg-white rounded-lg shadow-xl p-8 text-center"><h3 id="qrModalTitle" class="text-xl font-semibold mb-4"></h3><canvas id="qrCanvas" class="mx-auto"></canvas><button onclick="hideModal('qrModal')" class="mt-6 px-6 py-2 bg-indigo-600 text-white rounded-lg">Close</button></div></div>
  <div id="receiptModal" class="modal pointer-events-none fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 opacity-0"><div class="modal-content bg-white rounded-lg shadow-xl p-8 w-full max-w-md text-center"><h3 class="text-2xl font-bold text-green-600 mb-2">ยืมสำเร็จ!</h3><p class="text-gray-600 mb-6">กรุณาบันทึก QR Code นี้สำหรับคืนอุปกรณ์</p><canvas id="receiptQrCanvas" class="mx-auto border rounded-lg"></canvas><div id="receiptDetails" class="text-left mt-6 text-sm"></div><button onclick="hideModal('receiptModal')" class="mt-8 px-6 py-2 bg-indigo-600 text-white rounded-lg w-full">Close</button></div></div>
  <div id="returnModal" class="modal pointer-events-none fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 opacity-0"><div class="modal-content bg-white rounded-lg shadow-xl p-8 w-full max-w-lg"><h3 class="text-xl font-semibold mb-4">คืนอุปกรณ์</h3><div id="returnDetails" class="text-sm mb-4 border-b pb-4"></div><h4 class="text-lg font-semibold text-gray-700 mb-3">รายการที่ยืม:</h4><div id="return-items-list" class="space-y-3"></div><div id="return-actions" class="mt-6 flex justify-end space-x-3"></div></div></div>
  <div id="deviceDetailModal" class="modal pointer-events-none fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 opacity-0"><div class="modal-content bg-white rounded-lg shadow-xl p-8 w-full max-w-lg"><h3 id="deviceDetailTitle" class="text-2xl font-bold text-gray-800 mb-6">Device Details</h3><div id="deviceDetailContent" class="space-y-2 border-t border-b py-4"></div><div class="mt-6 flex justify-end space-x-4"><button onclick="hideModal('deviceDetailModal')" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Close</button><button id="addToCartButton" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Add to Cart</button></div></div></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, addDoc, setDoc, deleteDoc, writeBatch, serverTimestamp, getDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyAqZ-xhY6WtIu4CEMOZqITWvqlnc5vF4Ew", authDomain: "inventory-eedef.firebaseapp.com", projectId: "inventory-eedef", storageBucket: "inventory-eedef.appspot.com", messagingSenderId: "1089383656081", appId: "1:1089383656081:web:bb8e8237a701f356102d30" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let allData = { Computers: [], Monitors: [], Audio: [], LoanHistory: [], Software: [], Location: [] };
    let currentEdit = { mode: null, collection: null, id: null };
    let cartItems = [];
    let html5QrCode;
    let statusChart;

    const collectionConfigs = {
        Computers: { 
            headers: ['ComputerName', 'SerialNumber', 'UserName', 'Status', 'Type', 'Location', 'WarrantyEndDate'], 
            nameField: 'ComputerName', 
            serialField: 'SerialNumber', 
            icon: 'fa-laptop',
            dropdowns: {
                Status: ['Active', 'On Loan', 'Repair', 'Storage', 'Damaged', 'Disposed'],
                Type: ['Desktop', 'Laptop', 'POS']
            }
        },
        Monitors: { 
            headers: ['ComputerName', 'Model', 'MonitorSerial', 'Status', 'WarrantyEndDate'], 
            nameField: 'Model', 
            serialField: 'MonitorSerial', 
            icon: 'fa-desktop',
            dropdowns: {
                Status: ['Active', 'On Loan', 'Repair', 'Storage', 'Damaged', 'Disposed']
            }
        },
        Audio: { 
            headers: ['ItemName', 'Manufacturer', 'Model', 'SerialNumber', 'Status', 'WarrantyEndDate'], 
            nameField: 'ItemName', 
            serialField: 'SerialNumber', 
            icon: 'fa-volume-up',
            dropdowns: {
                Status: ['Active', 'On Loan', 'Repair', 'Storage', 'Damaged', 'Disposed']
            }
        }
    };

    // --- Mobile Navigation ---
    const sidebar = document.getElementById('sidebar');
    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const sidebarOverlay = document.getElementById('sidebar-overlay');

    function toggleMobileNav() {
        sidebar.classList.toggle('-translate-x-full');
        sidebarOverlay.classList.toggle('hidden');
    }
    mobileMenuButton.addEventListener('click', toggleMobileNav);
    sidebarOverlay.addEventListener('click', toggleMobileNav);


    window.loadPage = (pageName, navElement) => {
        document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
        if (navElement) navElement.classList.add('active');
        document.querySelectorAll('.page-content').forEach(page => page.style.display = 'none');
        document.getElementById(pageName.toLowerCase() + '-page').style.display = 'block';
        if (pageName === 'Loan') populateCategories();
        if (pageName === 'Software') buildSoftwareCards(allData.Software);

        if (window.innerWidth < 768) {
            toggleMobileNav();
        }
    };

    function buildTable(collectionName, data, errorMessage = null) {
        const table = document.getElementById(collectionName + 'Table');
        if (!table) return;
        table.innerHTML = '';
        const { headers, nameField, serialField } = collectionConfigs[collectionName];
        const displayHeaders = [...headers, 'Actions'];
        const thead = document.createElement('thead');
        thead.className = 'bg-gray-50';
        thead.innerHTML = `<tr>${displayHeaders.map(h => `<th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">${h}</th>`).join('')}</tr>`;
        table.appendChild(thead);
        const tbody = document.createElement('tbody');
        tbody.className = 'divide-y divide-gray-200';
        if (errorMessage) tbody.innerHTML = `<tr><td class="px-6 py-4 text-center text-red-600" colspan="${displayHeaders.length}">${errorMessage}</td></tr>`;
        else if (data.length === 0) tbody.innerHTML = `<tr><td class="px-6 py-4 text-center text-gray-500" colspan="${displayHeaders.length}">No data found.</td></tr>`;
        else {
            data.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition-colors";
                headers.forEach(header => tr.innerHTML += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${item[header] || ''}</td>`);
                tr.innerHTML += `<td class="px-6 py-4 text-sm font-medium space-x-4"><button onclick="openModal('edit', '${collectionName}', '${item.id}')" class="text-indigo-600 hover:text-indigo-800"><i class="fas fa-edit"></i></button><button onclick="deleteItem('${collectionName}', '${item.id}')" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button><button onclick="showQrModal('${item[serialField]}', '${item[nameField]}', 'device')" class="text-gray-500 hover:text-gray-800"><i class="fas fa-qrcode"></i></button></td>`;
                tbody.appendChild(tr);
            });
        }
        table.appendChild(tbody);
    }

    function buildLoanHistoryCards(data, errorMessage = null) {
        const container = document.getElementById('LoanHistoryContainer');
        if (!container) return;
        container.innerHTML = '';

        if (errorMessage) {
            container.innerHTML = `<p class="text-center py-10 text-red-600">${errorMessage}</p>`;
            return;
        }
        if (data.length === 0) {
            container.innerHTML = `<p class="text-center py-10 text-gray-500">No loan history found.</p>`;
            return;
        }

        const groupedLoans = data.reduce((acc, loan) => {
            const groupId = loan.LoanGroupID;
            if (!acc[groupId]) {
                acc[groupId] = {
                    loanGroupId: groupId,
                    borrowerName: loan.BorrowerName,
                    loanDate: loan.LoanDate,
                    items: []
                };
            }
            acc[groupId].items.push(loan);
            return acc;
        }, {});

        const sortedGroups = Object.values(groupedLoans).sort((a, b) => {
            const dateA = a.loanDate?.toDate ? a.loanDate.toDate() : new Date(a.loanDate || 0);
            const dateB = b.loanDate?.toDate ? b.loanDate.toDate() : new Date(b.loanDate || 0);
            return dateB - dateA;
        });

        sortedGroups.forEach(group => {
            const allReturned = group.items.every(item => item.Status === 'Returned');
            const status = allReturned ? 'Returned' : 'On Loan';
            const loanDate = group.loanDate?.toDate ? group.loanDate.toDate().toLocaleDateString('th-TH') : 'N/A';
            const statusColor = status === 'On Loan' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800';
            
            const itemsHtml = group.items.map(item => {
                const returnDate = item.ReturnDate?.toDate ? item.ReturnDate.toDate().toLocaleDateString('th-TH') : '';
                return `<li class="flex justify-between items-center py-2 px-4 border-b last:border-b-0">
                            <div>
                                <p class="text-sm font-medium text-gray-800">${item.DeviceSerial} (${item.DeviceType})</p>
                                <p class="text-xs text-gray-500">Return Date: ${returnDate}</p>
                            </div>
                            <span class="text-xs font-semibold py-1 px-2.5 rounded-full ${item.Status === 'On Loan' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">${item.Status}</span>
                        </li>`;
            }).join('');

            const actionButton = status === 'On Loan'
                ? `<button onclick="showQrModal('${group.loanGroupId}', 'Return QR for ${group.borrowerName}', 'return')" class="text-gray-500 hover:text-gray-800 ml-4"><i class="fas fa-qrcode"></i></button>`
                : '';

            const card = document.createElement('div');
            card.className = "loan-card bg-white rounded-lg shadow-sm overflow-hidden";
            card.innerHTML = `
                <details class="group" ${status === 'On Loan' ? 'open' : ''}>
                    <summary class="p-4 flex justify-between items-center cursor-pointer hover:bg-gray-50 transition-colors">
                        <div>
                            <p class="borrower-name font-semibold text-lg text-gray-900">${group.borrowerName}</p>
                            <p class="text-xs text-gray-500 mt-1">Loan Date: ${loanDate} | ID: ${group.loanGroupId}</p>
                        </div>
                        <div class="flex items-center">
                            <span class="text-xs font-semibold py-1 px-2.5 rounded-full ${statusColor}">${status}</span>
                            ${actionButton}
                            <i class="fas fa-chevron-down text-gray-400 ml-4 transform group-open:rotate-180 transition-transform"></i>
                        </div>
                    </summary>
                    <div class="bg-gray-50 border-t border-gray-200">
                        <ul>${itemsHtml}</ul>
                    </div>
                </details>
            `;
            container.appendChild(card);
        });
    }

    function buildSoftwareCards(softwareData, errorMessage = null) {
        const container = document.getElementById('SoftwareContainer');
        if (!container) return;
        container.innerHTML = '';
        if (errorMessage) {
            container.innerHTML = `<p class="text-center py-10 text-red-600">${errorMessage}</p>`;
            return;
        }
        if (!softwareData || softwareData.length === 0) {
            container.innerHTML = `<p class="text-center py-10 text-gray-500">No software data found.</p>`;
            return;
        }

        const groupedSoftware = softwareData.reduce((acc, sw) => {
            const computerName = sw.ComputerName;
            if (!acc[computerName]) {
                acc[computerName] = [];
            }
            acc[computerName].push(sw);
            return acc;
        }, {});

        Object.keys(groupedSoftware).sort().forEach(computerName => {
            const softwareList = groupedSoftware[computerName];
            const itemsHtml = softwareList.map(sw => `<li class="flex justify-between items-center py-2 px-4 border-b last:border-b-0 text-sm text-gray-800"><span>${sw.SoftwareName}</span><span>${sw.Version || ''}</span></li>`).join('');

            const card = document.createElement('div');
            card.className = "software-card bg-white rounded-lg shadow-sm overflow-hidden";
            card.innerHTML = `
                <details class="group">
                    <summary class="p-4 flex justify-between items-center cursor-pointer hover:bg-gray-50 transition-colors">
                        <div class="flex items-center">
                            <i class="fas fa-laptop text-indigo-500 mr-3"></i>
                            <span class="font-semibold text-gray-900">${computerName}</span>
                            <span class="ml-2 text-xs bg-gray-200 text-gray-600 font-medium px-2 py-0.5 rounded-full">${softwareList.length} apps</span>
                        </div>
                        <i class="fas fa-chevron-down text-gray-400 transform group-open:rotate-180 transition-transform"></i>
                    </summary>
                    <div class="bg-gray-50 border-t border-gray-200 max-h-72 overflow-y-auto">
                        <ul>${itemsHtml}</ul>
                    </div>
                </details>
            `;
            container.appendChild(card);
        });
    }

    window.filterTable = (tableId, filterText) => {
        const rows = document.getElementById(tableId).getElementsByTagName("tr");
        const filter = filterText.toUpperCase();
        for (let i = 1; i < rows.length; i++) rows[i].style.display = rows[i].textContent.toUpperCase().includes(filter) ? "" : "none";
    };
    
    window.filterLoanHistory = (filterText) => {
        const cards = document.querySelectorAll('#LoanHistoryContainer .loan-card');
        const filter = filterText.toUpperCase();
        cards.forEach(card => {
            card.style.display = card.textContent.toUpperCase().includes(filter) ? "" : "none";
        });
    };

    window.filterSoftwareCards = (filterText) => {
        const cards = document.querySelectorAll('#SoftwareContainer .software-card');
        const filter = filterText.toUpperCase();
        cards.forEach(card => {
            card.style.display = card.textContent.toUpperCase().includes(filter) ? "" : "none";
        });
    };


    window.openModal = (mode, collection, id = null) => {
        currentEdit = { mode, collection, id };
        const form = document.getElementById('editForm');
        form.innerHTML = '';
        const config = collectionConfigs[collection];
        const { headers, dropdowns } = config;
        const itemData = (mode === 'edit') ? allData[collection].find(i => i.id === id) : {};
        document.getElementById('editModalTitle').textContent = `${mode === 'edit' ? 'Edit' : 'Add'} ${collection.slice(0, -1)}`;
        
        headers.forEach(header => {
            const value = itemData[header] || '';
            let fieldHtml = `<div><label class="block text-sm font-medium text-gray-700">${header}</label>`;
            
            if (header === 'Location' && allData.Location.length > 0) {
                fieldHtml += `
                    <div class="relative">
                        <input type="text" id="locationSearchInput" name="Location" value="${value}"
                               onkeyup="filterLocations(this.value)"
                               onfocus="document.getElementById('locationDropdown').classList.remove('hidden')"
                               placeholder="Search or select location..."
                               autocomplete="off"
                               class="mt-1 block w-full px-3 py-2 border rounded-md bg-white">
                        <div id="locationDropdown" class="hidden absolute z-10 w-full bg-white border rounded-md mt-1 max-h-48 overflow-y-auto shadow-lg">`;
                allData.Location.forEach(loc => {
                    fieldHtml += `<a href="#" data-value="${loc.LocationName}" class="location-item block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">${loc.LocationName}</a>`;
                });
                fieldHtml += `</div></div>`;
            } else if (header.toLowerCase().includes('date')) {
                fieldHtml += `<input type="date" name="${header}" value="${value}" class="mt-1 block w-full px-3 py-2 border rounded-md bg-white">`;
            } else if (dropdowns && dropdowns[header]) {
                const options = dropdowns[header];
                fieldHtml += `<select name="${header}" class="mt-1 block w-full px-3 py-2 border rounded-md bg-white">`;
                options.forEach(opt => {
                    const isSelected = value === opt ? 'selected' : '';
                    fieldHtml += `<option value="${opt}" ${isSelected}>${opt}</option>`;
                });
                fieldHtml += `</select>`;
            } else {
                fieldHtml += `<input type="text" name="${header}" value="${value}" class="mt-1 block w-full px-3 py-2 border rounded-md bg-white">`;
            }
            fieldHtml += `</div>`;
            form.innerHTML += fieldHtml;
        });
        
        const locationDropdown = form.querySelector('#locationDropdown');
        if (locationDropdown) {
            form.querySelector('#locationSearchInput').addEventListener('blur', () => {
                setTimeout(() => locationDropdown.classList.add('hidden'), 200);
            });
            locationDropdown.addEventListener('click', (e) => {
                if (e.target.classList.contains('location-item')) {
                    e.preventDefault();
                    form.querySelector('#locationSearchInput').value = e.target.dataset.value;
                    locationDropdown.classList.add('hidden');
                }
            });
        }

        document.getElementById('editModal').classList.remove('opacity-0', 'pointer-events-none');
    };
    
    window.filterLocations = (filterText) => {
        const filter = filterText.toUpperCase();
        const dropdown = document.getElementById('locationDropdown');
        const items = dropdown.getElementsByTagName('a');
        for (let i = 0; i < items.length; i++) {
            const txtValue = items[i].textContent || items[i].innerText;
            items[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? "" : "none";
        }
    };

    window.hideModal = (modalId) => document.getElementById(modalId).classList.add('opacity-0', 'pointer-events-none');

    window.saveData = async () => {
        const formData = new FormData(document.getElementById('editForm'));
        const data = Object.fromEntries(formData.entries());
        const { mode, collection, id } = currentEdit;
        try {
            if (mode === 'edit') await setDoc(doc(db, collection, id), data);
            else await addDoc(collection(db, collection), data);
            hideModal('editModal');
        } catch (error) { console.error("Error:", error); alert("Failed to save."); }
    };

    window.deleteItem = async (collectionName, id) => {
        if (confirm(`Are you sure?`)) try { await deleteDoc(doc(db, collectionName, id)); } catch (error) { console.error("Error:", error); alert("Failed to delete."); }
    };

    window.showQrModal = (data, name, type) => {
        document.getElementById('qrModalTitle').textContent = `QR Code for ${name}`;
        let url;
        if (type === 'device') {
            url = `${window.location.origin}${window.location.pathname.replace('index.html', '')}details.html?sn=${data}`;
        } else { // type === 'return'
            url = `${window.location.origin}${window.location.pathname.replace('index.html', '')}return.html?id=${data}`;
        }
        QRCode.toCanvas(document.getElementById('qrCanvas'), url, { width: 256 });
        document.getElementById('qrModal').classList.remove('opacity-0', 'pointer-events-none');
    };

    window.switchLoanTab = (tabName, btn) => {
        document.querySelectorAll('#loan-page .tab-button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('scan-view').style.display = tabName === 'scan' ? 'block' : 'none';
        document.getElementById('select-view').style.display = tabName === 'select' ? 'block' : 'none';
    };

    function populateCategories() {
        const container = document.getElementById('category-selection');
        container.innerHTML = `<h3 class="text-lg font-semibold mb-3 text-gray-700">เลือกหมวดหมู่อุปกรณ์</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4">`;
        for (const key in collectionConfigs) {
            const config = collectionConfigs[key];
            const availableItems = allData[key].filter(item => item.Status === 'Active').length;
            container.firstElementChild.innerHTML += `<div class="border rounded-lg p-4 flex flex-col items-center justify-center text-center hover:bg-gray-50 cursor-pointer" onclick="showDeviceCategory('${key}')"><i class="fas ${config.icon} text-4xl text-blue-500 mb-2"></i><p class="font-semibold text-gray-800">${key}</p><p class="text-xs text-gray-500">${availableItems} items available</p></div>`;
        }
        container.innerHTML += `</div>`;
    }

    window.showDeviceCategory = (collectionName) => {
        document.getElementById('category-selection').style.display = 'none';
        document.getElementById('device-list-view').style.display = 'block';
        const container = document.getElementById('device-list-container');
        container.innerHTML = '';
        const availableItems = allData[collectionName].filter(item => item.Status === 'Active');
        if (availableItems.length > 0) {
            let html = `<div class="grid grid-cols-1 md:grid-cols-2 gap-3">`;
            availableItems.forEach(item => {
                const isSelected = cartItems.some(c => c.id === item.id);
                html += `<div class="device-card border rounded-lg p-3 flex items-center space-x-3 hover:bg-gray-50 cursor-pointer ${isSelected ? 'selected' : ''}" onclick="toggleCartItem(this, '${collectionName}', '${item.id}')"><i class="fas ${collectionConfigs[collectionName].icon} text-2xl text-gray-400"></i><div class="flex-1"><p class="font-semibold text-sm text-gray-800">${item[collectionConfigs[collectionName].nameField]}</p><p class="text-xs text-gray-500">SN: ${item[collectionConfigs[collectionName].serialField]}</p></div><i class="fas fa-check-circle text-blue-500 text-xl selected-icon"></i></div>`;
            });
            container.innerHTML = html + `</div>`;
        } else container.innerHTML = `<p class="text-sm text-gray-500">No devices available.</p>`;
    };

    window.showCategorySelection = () => {
        document.getElementById('category-selection').style.display = 'block';
        document.getElementById('device-list-view').style.display = 'none';
    };

    window.toggleCartItem = (cardElement, collectionName, id) => {
        cardElement.classList.toggle('selected');
        const isInCart = cartItems.some(c => c.id === id);
        if (isInCart) cartItems = cartItems.filter(c => c.id !== id);
        else addDeviceToCart(collectionName, id);
        renderCart();
    };

    window.startScanning = () => {
        document.getElementById('start-scan-button').disabled = true;
        html5QrCode = new Html5Qrcode("qr-reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, code => handleScannedCode(code));
    };
    
    async function handleScannedCode(code) {
        try {
            const url = new URL(code);
            const path = url.pathname.split('/').pop();
            if (path === 'details.html') {
                const sn = url.searchParams.get('sn');
                const deviceResult = findDeviceBySerial(sn);
                if (deviceResult) showDeviceDetails(deviceResult.item, deviceResult.collectionName);
                else alert(`Device with SN ${sn} not found.`);
            } else if (path === 'return.html') {
                const loanGroupId = url.searchParams.get('id');
                const q = query(collection(db, "LoanHistory"), where("LoanGroupID", "==", loanGroupId));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    const loanItems = querySnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    showReturnModal(loanGroupId, loanItems);
                } else {
                    alert(`Loan with ID ${loanGroupId} not found.`);
                }
            }
        } catch (e) {
            // Not a valid URL, assume it's a serial or loan group ID
            const q = query(collection(db, "LoanHistory"), where("LoanGroupID", "==", code));
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) {
                const loanItems = querySnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                showReturnModal(code, loanItems);
            } else {
                const deviceResult = findDeviceBySerial(code);
                if (deviceResult) showDeviceDetails(deviceResult.item, deviceResult.collectionName);
                else alert(`Device or Loan with ID ${code} not found.`);
            }
        }
    }

    function findDeviceBySerial(serial) {
        for (const cName in collectionConfigs) {
            const item = allData[cName]?.find(i => i[collectionConfigs[cName].serialField] === serial);
            if (item) {
                return { item, collectionName: cName };
            }
        }
        return null;
    }

    function showDeviceDetails(item, collectionName) {
        const modal = document.getElementById('deviceDetailModal');
        const title = document.getElementById('deviceDetailTitle');
        const content = document.getElementById('deviceDetailContent');
        const addToCartBtn = document.getElementById('addToCartButton');

        title.textContent = item[collectionConfigs[collectionName].nameField] || 'Device Details';
        
        content.innerHTML = '';
        const headers = collectionConfigs[collectionName].headers;
        headers.forEach(header => {
            content.innerHTML += `<div class="flex justify-between border-b py-2"><span class="text-gray-500">${header}</span><span class="font-semibold text-gray-800">${item[header] || 'N/A'}</span></div>`;
        });

        addToCartBtn.onclick = () => {
            addDeviceToCart(collectionName, item.id);
            hideModal('deviceDetailModal');
        };

        modal.classList.remove('opacity-0', 'pointer-events-none');
    }

    function addDeviceToCart(collectionName, id) {
        const item = allData[collectionName]?.find(i => i.id === id);
        if (!item) { alert('Device not found!'); return; }
        if (item.Status !== 'Active') { alert(`Not available. Status: ${item.Status}`); return; }
        if (cartItems.some(c => c.id === id)) { alert('Already in cart.'); return; }
        cartItems.push({ ...item, collection: collectionName });
        renderCart();
    }

    function renderCart() {
        const cartDiv = document.getElementById('cart');
        cartDiv.innerHTML = cartItems.length === 0 ? '<p class="text-sm text-gray-500">ยังไม่มีอุปกรณ์ในตะกร้า</p>' : '';
        cartItems.forEach((item, index) => {
            const name = item.ComputerName || item.Model || item.ItemName;
            cartDiv.innerHTML += `<div class="flex justify-between items-center bg-gray-100 p-2 rounded"><span class="text-sm">${name}</span><button type="button" onclick="removeFromCart(${index})" class="text-red-500 font-bold">X</button></div>`;
        });
    }
    
    window.removeFromCart = (index) => {
        const removedItem = cartItems.splice(index, 1)[0];
        renderCart();
        const card = document.querySelector(`.device-card[onclick*="'${removedItem.id}'"]`);
        if (card) card.classList.remove('selected');
    };

    window.submitLoan = async () => {
        const borrowerName = document.getElementById('borrowerName').value;
        const dueDate = document.getElementById('dueDate').value;
        const notes = document.getElementById('loanNotes').value;
        if (!borrowerName || !dueDate || cartItems.length === 0) return alert('Please fill all fields and add items.');
        
        const loanGroupId = `GRP-${Date.now()}`;
        const batch = writeBatch(db);

        cartItems.forEach(item => {
            const transactionId = `TXN-${Date.now()}-${Math.random().toString(36).substring(2, 7)}`;
            const loanDocRef = doc(db, "LoanHistory", transactionId);
            const loanData = {
                LoanGroupID: loanGroupId,
                TransactionID: transactionId,
                DeviceSerial: item[collectionConfigs[item.collection].serialField],
                DeviceType: item.collection,
                BorrowerName: borrowerName,
                LoanDate: serverTimestamp(),
                DueDate: new Date(dueDate),
                ReturnDate: null,
                Status: 'On Loan',
                Notes: notes || ""
            };
            batch.set(loanDocRef, loanData);
            const itemRef = doc(db, item.collection, item.id);
            batch.update(itemRef, { Status: 'On Loan' });
        });

        try {
            await batch.commit();
            showLoanReceipt(loanGroupId, { borrowerName, dueDate, items: cartItems });
            cartItems = [];
            renderCart();
            document.getElementById('loanForm').reset();
        } catch (error) { console.error("Error:", error); alert('Failed to submit loan.'); }
    };
    
    function showLoanReceipt(loanGroupId, loanDetails) {
        const modal = document.getElementById('receiptModal');
        const canvas = document.getElementById('receiptQrCanvas');
        const detailsDiv = document.getElementById('receiptDetails');
        const url = `${window.location.origin}${window.location.pathname.replace('index.html', '')}return.html?id=${loanGroupId}`;
        QRCode.toCanvas(canvas, url, { width: 256 });
        let detailsHtml = `<p><strong>ผู้ยืม:</strong> ${loanDetails.borrowerName}</p><p><strong>กำหนดคืน:</strong> ${loanDetails.dueDate}</p><h4 class="font-semibold mt-4 mb-2">รายการ:</h4><ul class="list-disc list-inside">`;
        loanDetails.items.forEach(item => { detailsHtml += `<li>${item.ComputerName || item.Model || item.ItemName}</li>`; });
        detailsHtml += `</ul>`;
        detailsDiv.innerHTML = detailsHtml;
        modal.classList.remove('opacity-0', 'pointer-events-none');
    }

    function showReturnModal(loanGroupId, loanItems) {
        const modal = document.getElementById('returnModal');
        const firstItem = loanItems[0];
        document.getElementById('returnDetails').innerHTML = `<p><strong>Loan Group ID:</strong> ${loanGroupId}</p><p><strong>ผู้ยืม:</strong> ${firstItem.BorrowerName}</p>`;
        const itemsList = document.getElementById('return-items-list');
        const actionsDiv = document.getElementById('return-actions');
        itemsList.innerHTML = '';
        actionsDiv.innerHTML = '<button onclick="hideModal(\'returnModal\')" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Close</button>';
        
        let hasItemsToReturn = false;
        loanItems.forEach(item => {
            const device = allData[item.DeviceType]?.find(d => d[collectionConfigs[item.DeviceType].serialField] === item.DeviceSerial);
            const deviceName = device?.[collectionConfigs[item.DeviceType].nameField] || item.DeviceSerial;
            const isReturned = item.Status === 'Returned';
            if (!isReturned) hasItemsToReturn = true;

            let buttonHtml = isReturned 
                ? `<span class="text-sm text-gray-500 font-medium inline-flex items-center"><i class="fas fa-check-circle text-green-500 mr-1.5"></i>Returned</span>`
                : `<button onclick="processReturn('${item.TransactionID}', '${item.DeviceSerial}', '${item.DeviceType}')" class="text-sm bg-green-500 text-white font-semibold py-1 px-3 rounded-full hover:bg-green-600">Return</button>`;
            itemsList.innerHTML += `<div class="flex justify-between items-center py-2 border-b"><p>${deviceName}</p>${buttonHtml}</div>`;
        });

        if (hasItemsToReturn) {
            actionsDiv.insertAdjacentHTML('afterbegin', `<button onclick="processReturnAll()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Return All</button>`);
        }

        modal.classList.remove('opacity-0', 'pointer-events-none');
    }

    window.processReturn = async (transactionId, deviceSerial, deviceType) => {
        if (!confirm('Confirm return of this item?')) return;
        try {
            const batch = writeBatch(db);
            const transactionRef = doc(db, "LoanHistory", transactionId);
            batch.update(transactionRef, { Status: 'Returned', ReturnDate: serverTimestamp() });
            const device = allData[deviceType]?.find(d => d[collectionConfigs[deviceType].serialField] === deviceSerial);
            if (device) {
                const deviceRef = doc(db, deviceType, device.id);
                batch.update(deviceRef, { Status: 'Active' });
            }
            await batch.commit();
            alert('Item returned successfully!');
            hideModal('returnModal');
        } catch (error) { console.error("Error:", error); alert('Failed to return item.'); }
    }
    
    window.processReturnAll = async () => {
        const loanGroupId = document.getElementById('returnDetails').querySelector('p').textContent.split(': ')[1];
        const loanItems = allData.LoanHistory.filter(item => item.LoanGroupID === loanGroupId);
        const itemsToReturn = loanItems.filter(item => item.Status === 'On Loan');
        if (itemsToReturn.length === 0) {
            alert("All items have already been returned.");
            return;
        }
        if (!confirm(`Are you sure you want to return all ${itemsToReturn.length} remaining items?`)) return;

        try {
            const batch = writeBatch(db);
            for (const item of itemsToReturn) {
                const transactionRef = doc(db, "LoanHistory", item.id);
                batch.update(transactionRef, { Status: 'Returned', ReturnDate: serverTimestamp() });
                const device = allData[item.DeviceType]?.find(d => d[collectionConfigs[item.DeviceType].serialField] === item.DeviceSerial);
                if (device) {
                    const deviceRef = doc(db, item.DeviceType, device.id);
                    batch.update(deviceRef, { Status: 'Active' });
                }
            }
            await batch.commit();
            alert('All items returned successfully!');
            hideModal('returnModal');
        } catch (error) {
            console.error("Error returning all items: ", error);
            alert('Failed to return all items.');
        }
    }


    function listenToCollection(collectionName, config) {
        onSnapshot(collection(db, collectionName), (snapshot) => {
            allData[collectionName] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (config.isInventory) {
                buildTable(collectionName, allData[collectionName]);
            } else if (collectionName === 'Software') {
                buildSoftwareCards(allData[collectionName]);
            } else if (collectionName === 'LoanHistory') {
                buildLoanHistoryCards(allData[collectionName]);
            }
            updateDashboard();
        }, (error) => {
            console.error(`Error listening to ${collectionName}: `, error);
            let msg = `Error fetching data for ${collectionName}.`;
            if (error.code === 'permission-denied') msg = `Permission Denied. Check Firestore Rules.`;
            if (config.isInventory) buildTable(collectionName, [], msg);
            else if (collectionName === 'LoanHistory') buildLoanHistoryCards([], msg);
            else if (collectionName === 'Software') buildSoftwareCards([], msg);
        });
    }
    
    function updateDashboard() {
        const computers = allData['Computers'] || [];
        const monitors = allData['Monitors'] || [];
        const audio = allData['Audio'] || [];
        const allDevices = [...computers, ...monitors, ...audio];
        
        document.getElementById('stat-total-computers').textContent = computers.length;
        document.getElementById('stat-total-monitors').textContent = monitors.length;
        document.getElementById('stat-total-audio').textContent = audio.length;
        document.getElementById('stat-total-onloan').textContent = allDevices.filter(d => d.Status === 'On Loan').length;

        const desktops = computers.filter(c => c.Type === 'Desktop');
        const laptops = computers.filter(c => c.Type === 'Laptop');
        document.getElementById('stat-total-desktops').textContent = desktops.length;
        document.getElementById('stat-desktops-active').textContent = desktops.filter(d => d.Status === 'Active').length;
        document.getElementById('stat-desktops-on-loan').textContent = desktops.filter(d => d.Status === 'On Loan').length;
        document.getElementById('stat-desktops-repair').textContent = desktops.filter(d => d.Status === 'Repair').length;
        document.getElementById('stat-total-laptops').textContent = laptops.length;
        document.getElementById('stat-laptops-active').textContent = laptops.filter(l => l.Status === 'Active').length;
        document.getElementById('stat-laptops-on-loan').textContent = laptops.filter(l => l.Status === 'On Loan').length;
        document.getElementById('stat-laptops-repair').textContent = laptops.filter(l => l.Status === 'Repair').length;
        
        document.getElementById('stat-monitors-active').textContent = monitors.filter(m => m.Status === 'Active').length;
        document.getElementById('stat-monitors-on-loan').textContent = monitors.filter(m => m.Status === 'On Loan').length;
        document.getElementById('stat-monitors-repair').textContent = monitors.filter(m => m.Status === 'Repair').length;
        
        const statusCounts = allDevices.reduce((acc, device) => {
            if(device.Status) {
               acc[device.Status] = (acc[device.Status] || 0) + 1;
            }
            return acc;
        }, {});
        
        renderStatusChart(statusCounts);

        const recentLoans = (allData['LoanHistory'] || [])
            .sort((a, b) => {
                const dateA = a.LoanDate?.toDate ? a.LoanDate.toDate() : new Date(a.LoanDate || 0);
                const dateB = b.LoanDate?.toDate ? b.LoanDate.toDate() : new Date(b.LoanDate || 0);
                return dateB - dateA;
            })
            .slice(0, 5);
        renderRecentLoans(recentLoans);
    }
    
    function renderStatusChart(statusData) {
        const ctx = document.getElementById('statusChart').getContext('2d');
        const labels = Object.keys(statusData);
        const data = Object.values(statusData);

        if (statusChart) {
            statusChart.data.labels = labels;
            statusChart.data.datasets[0].data = data;
            statusChart.update();
        } else {
            statusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Device Status',
                        data: data,
                        backgroundColor: [
                            '#22C55E', // green-500 for Active
                            '#F59E0B', // amber-500 for On Loan
                            '#F97316', // orange-500 for Repair
                            '#3B82F6', // blue-500 for Storage
                            '#EF4444', // red-500 for Damaged
                            '#6B7280'  // gray-500 for Disposed
                        ],
                        borderColor: '#ffffff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
        }
    }

    function renderRecentLoans(loans) {
        const tbody = document.getElementById('recent-loans-table');
        tbody.innerHTML = '';
        if (loans.length === 0) {
            tbody.innerHTML = `<tr><td colspan="3" class="text-center text-gray-500 py-4">No recent activity</td></tr>`;
            return;
        }
        loans.forEach(loan => {
            const loanDateObj = loan.LoanDate?.toDate ? loan.LoanDate.toDate() : new Date(loan.LoanDate || null);
            const loanDate = !isNaN(loanDateObj) ? loanDateObj.toLocaleDateString('th-TH') : 'N/A';
            const statusColor = loan.Status === 'On Loan' ? 'text-yellow-600' : 'text-green-600';
            tbody.innerHTML += `
                <tr class="text-sm">
                    <td class="px-4 py-2 font-medium text-gray-800">${loan.BorrowerName}</td>
                    <td class="px-4 py-2 text-gray-600">${loanDate}</td>
                    <td class="px-4 py-2 font-semibold ${statusColor}">${loan.Status}</td>
                </tr>
            `;
        });
    }

    window.resetAllStatusToActive = async function() {
        if (!confirm('Are you sure you want to reset the status of ALL devices to "Active"? This action cannot be undone.')) return;
        alert('Updating statuses... This may take a moment.');
        try {
            const batch = writeBatch(db);
            for (const collectionName in collectionConfigs) {
                allData[collectionName].forEach(item => {
                    const docRef = doc(db, collectionName, item.id);
                    batch.update(docRef, { Status: 'Active' });
                });
            }
            await batch.commit();
            alert('All device statuses have been successfully reset to "Active".');
        } catch (error) { console.error("Error:", error); alert("An error occurred."); }
    }

    window.addEventListener('load', () => {
        listenToCollection('Computers', { isInventory: true });
        listenToCollection('Monitors', { isInventory: true });
        listenToCollection('Audio', { isInventory: true });
        listenToCollection('Software', { isInventory: false });
        listenToCollection('LoanHistory', { isInventory: false });
        listenToCollection('Location', { isInventory: false });
        document.getElementById('loading-state').style.display = 'none';
        loadPage('Dashboard', document.getElementById('nav-dashboard'));
    });
  </script>
</body>
</html>
